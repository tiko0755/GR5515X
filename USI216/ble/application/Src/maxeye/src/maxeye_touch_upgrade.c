#include "gr55xx.h"
#include "app_log.h"
#include "app_error.h"
#include "app_i2c.h"

#include "hal_flash.h"

#include "maxeye_wdt.h"
#include "maxeye_i2c.h"
#include "maxeye_touch.h"
#include "maxeye_touch_upgrade.h"


/*
 * DEFINES
 *****************************************************************************************
 */
#ifdef  UPGRADE_LOG_EN
#define LOG(format,...)  printf(format,##__VA_ARGS__) 
#else
#define LOG(format,...)  
#endif


#define TOUCH_7BIT_ADDR                            (0x38)

#define TOUCH_DELAY(X)                             delay_ms(X)

#define SEND_PACKAGE_SIZE                          128
#define FIRMWARE_SIZE                              0x7EA0//touch固件大小不能随意更改，需与固件大小一致



#define TOUCH_STATUS_OK                            0
#define ENTER_TOUCH_ROMBOOT_MODE_FAIL              1
#define READ_TOUCH_ROMBOOT_ID_FAIL                 2
#define WRITE_TOUCH_ROMBOOT_FAIL                   3
#define GET_TOUCH_ECC_FAIL                         4
#define TOUCH_ECC_VERIFY_FAIL                      5
#define TOUCH_ROMBOOT_RUN_FAIL                     6
#define ENTER_TOUCH_UPGRADE_MODE_FAIL              7
#define READ_TOUCH_UPGRADE_ID_FAIL                 8
#define ERASE_TOUCH_FLASH_FAIL                     9
#define WRITE_TOUCH_FIRMWARE_FAIL                  10
#define GET_TOUCH_FIRMWARE_ECC_FAIL                11
#define TOUCH_FIRMWARE_ECC_VERIFY_FAIL             12
#define TOUCH_UPGRADE_RESET_FAIL                   13


typedef struct
{
    uint8_t   pkHead;   
    uint8_t   pkAddH;
    uint8_t   pkAddM;
    uint8_t   pkAddL; 
	uint8_t   pkLenH;
	uint8_t   pkLenL; 
    uint8_t   pkbuff[SEND_PACKAGE_SIZE];  

} touch_package_t;




/*
 * LOCAL VARIABLE DEFINITIONS
 *****************************************************************************************
 */
const uint8_t  PramBoot[]={ \
0x2, 0x7, 0x70,0xca,0x39,0x12,0xd, 0x37,0xda,0x39,0x32,0x2, 0x0, 0x3, 0x6d,0x22,
0x80,0x13,0x75,0xb5,0x0, 0xa9,0x36,0xb3,0xfc,0xa9,0xc6,0xb3,0xe5,0xb5,0x7a,0xb, 
0xb0,0xb, 0x14,0xb, 0x24,0xbd,0x32,0x38,0xe9,0x22,0x22,0x2, 0xb, 0x36,0xa9,0xc2,
0xb4,0x74,0x5, 0x12,0xd, 0x18,0x12,0xc, 0xff,0xa9,0xd2,0xb4,0x30,0xe0,0x2, 0xd3,
0x22,0xc3,0x22,0x2, 0xd, 0x48,0xca,0x3b,0x7a,0xd, 0x8, 0x7f,0x31,0xe5,0x23,0xb4,
0x80,0x2, 0x80,0x3, 0x2, 0x0, 0xdc,0x7f,0x13,0x5e,0x34,0x0, 0x7f,0x7d,0x23,0x7e,
0x34,0x0, 0x80,0x9d,0x32,0x7a,0x35,0xe, 0x7e,0x35,0xc, 0xbe,0x35,0xe, 0x38,0x2, 
0x80,0x5d,0x7e,0x35,0xe, 0x7a,0x35,0x10,0x7f,0x13,0x7e,0xd, 0x8, 0x12,0xa, 0x5, 
0x7e,0x35,0xc, 0x9e,0x35,0xe, 0x7a,0x35,0xc, 0x7e,0x35,0xe, 0x6d,0x22,0x2f,0x31,
0x7e,0x1d,0x8, 0x2e,0x35,0xe, 0x7a,0x1d,0x8, 0x80,0x27,0x7e,0x34,0x0, 0x80,0x7a,
0x35,0x10,0x7f,0x13,0x7e,0xd, 0x8, 0x12,0xa, 0x5, 0x7e,0x35,0xc, 0x9e,0x34,0x0, 
0x80,0x7a,0x35,0xc, 0x7e,0x1d,0x8, 0x2e,0x34,0x0, 0x80,0x7a,0x1d,0x8, 0x2e,0x38,
0x0, 0x80,0x7e,0x35,0xc, 0xbe,0x34,0x0, 0x80,0x50,0xd0,0x4d,0x33,0x68,0x26,0x7a,
0x35,0x10,0x7f,0x13,0x7e,0xd, 0x8, 0x12,0xa, 0x5, 0x80,0x19,0x74,0x2, 0x12,0x9, 
0xa8,0x5e,0x70,0xf4,0x12,0xa, 0xad,0x7e,0x35,0xc, 0x7a,0x35,0x10,0x7f,0x13,0x7e,
0xd, 0x8, 0x12,0x6, 0x4b,0xd3,0xda,0x3b,0x22,0x75,0x17,0x62,0x75,0x18,0x1a,0x22,
0xd, 0x60,0xf2,0x9f,0x3b,0xf8,0xc4,0x7, 0xa3,0x4e,0x5c,0xb1,0xff,0xff,0xff,0x0, 
0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
0x7c,0x6b,0xc2,0x2, 0xe5,0x21,0x14,0x78,0x3, 0x2, 0x2, 0xbf,0x1b,0xb1,0x78,0x3, 
0x2, 0x2, 0x30,0x1b,0xb1,0x78,0x3, 0x2, 0x2, 0x7c,0x1b,0xb1,0x78,0x3, 0x2, 0x2, 
0x8d,0x1b,0xb1,0x78,0x3, 0x2, 0x2, 0xa6,0x24,0xf9,0x78,0x3, 0x2, 0x2, 0xbb,0x24,
0xaf,0x78,0x3, 0x2, 0x3, 0x29,0x24,0xfd,0x68,0x2d,0x14,0x78,0x3, 0x2, 0x2, 0xc2,
0x14,0x78,0x3, 0x2, 0x2, 0xbf,0x1b,0xb2,0x78,0x3, 0x2, 0x2, 0xbf,0x24,0xda,0x68,
0x19,0x24,0xe6,0x68,0x12,0x24,0xeb,0x68,0x2e,0x24,0xf3,0x78,0x3, 0x2, 0x2, 0xbf,
0x24,0x77,0x68,0x3, 0x2, 0x3, 0x33,0x2, 0x3, 0x30,0xbe,0x60,0x4, 0x50,0xc, 0x75,
0x16,0x0, 0x7c,0x16,0x2e,0x10,0x24,0x7c,0xb7,0xa5,0xf7,0xa5,0xbe,0x0, 0x2, 0x80,
0x3, 0x2, 0x3, 0x33,0xd2,0x2, 0x22,0x7c,0xb6,0x24,0x0, 0x78,0x3, 0x2, 0x3, 0x33,
0x1b,0xb1,0x68,0x1e,0x14,0x68,0x1e,0x14,0x68,0x1e,0x14,0x68,0x1e,0xb, 0xb2,0x78,
0x33,0x30,0x1, 0x7, 0x7e,0x8, 0x0, 0x3e,0x2, 0x2, 0x4d,0x7e,0x8, 0x1, 0x4a,0x2, 
0x2, 0x4d,0x2, 0x2, 0xe7,0x2, 0x2, 0xee,0x2, 0x3, 0x6, 0xa, 0x27,0x7e,0xd, 0x39,
0xb, 0x16,0xb, 0xa, 0x30,0x2d,0x32,0x1b,0xa, 0x30,0x6d,0x33,0x7e,0xd, 0x39,0x79,
0x30,0x0, 0x6, 0x22,0x7c,0xb7,0x62,0x16,0x7e,0x2d,0x39,0x2e,0x54,0x0, 0x6, 0xb, 
0x2a,0x20,0x7d,0x12,0xb, 0x14,0x1b,0x2a,0x10,0x7e,0xd, 0x39,0x2d,0x12,0x39,0x70,
0x0, 0x8, 0x7e,0xd, 0x39,0x69,0x50,0x0, 0x4, 0x69,0x20,0x0, 0x6, 0xbd,0x25,0x50,
0x3, 0x2, 0x3, 0x33,0xb2,0x1, 0x7a,0xd, 0x33,0x7e,0x34,0x0, 0x2, 0x2, 0x3, 0x25,
0x7c,0xb6,0x1b,0xb1,0x68,0x1d,0x14,0x68,0x1d,0xb, 0xb1,0x68,0x3, 0x2, 0x3, 0x33,
0x30,0x1, 0x6, 0x7e,0x8, 0x0, 0x3e,0x80,0x4, 0x7e,0x8, 0x1, 0x4a,0x7a,0xd, 0x39,
0x2, 0x2, 0xd6,0x2, 0x2, 0xe7,0xa, 0x57,0x6d,0x44,0x7e,0xd, 0x39,0x69,0x30,0x0, 
0x2, 0xb, 0xa, 0x20,0x2f,0x12,0x79,0x30,0x0, 0x2, 0x1b,0xa, 0x20,0x7e,0x1d,0x39,
0x7a,0x1d,0x33,0xd2,0x2, 0x7e,0x34,0x0, 0x1, 0x2, 0x3, 0x25,0xbe,0x60,0x1, 0x68,
0x9, 0xa5,0xbe,0x2, 0x5, 0x7a,0x71,0x3d,0xd2,0x3, 0xd2,0x2, 0x22,0x75,0xe6,0x0, 
0xe4,0x7e,0x34,0x1, 0x4, 0x7e,0x24,0x0, 0xff,0x7a,0x1b,0xb0,0x7e,0x34,0x1, 0x6, 
0x7a,0x1b,0xb0,0xd2,0x4, 0x22,0xa5,0xbe,0x1, 0x4, 0x7a,0x71,0x37,0x22,0xa5,0xbe,
0x2, 0x2, 0x80,0x3, 0x2, 0x3, 0x33,0x7a,0x71,0x22,0x22,0x7a,0x71,0x32,0x22,0xd2,
0x2, 0x22,0x1b,0x61,0x68,0x21,0x1b,0x60,0x68,0x24,0x1b,0x60,0x68,0x38,0x1b,0x60,
0x68,0x40,0xb, 0x62,0x78,0x5d,0xa, 0x37,0x7d,0x3, 0x6d,0x11,0x7e,0x1d,0x39,0x79,
0x11,0x0, 0x2, 0x1b,0x1a,0x0, 0x22,0xa, 0x57,0x7c,0xab,0xe4,0x80,0x2, 0xa, 0x57,
0x6d,0x44,0x7e,0xd, 0x39,0x69,0x30,0x0, 0x2, 0xb, 0xa, 0x20,0x2f,0x12,0x79,0x30,
0x0, 0x2, 0x1b,0xa, 0x20,0x22,0x7c,0x67,0x6c,0x77,0x7e,0xd, 0x39,0x79,0x30,0x0, 
0x4, 0x22,0xa, 0x27,0x7e,0xd, 0x39,0xb, 0x16,0xb, 0xa, 0x30,0x2d,0x32,0x1b,0xa, 
0x30,0x7e,0x34,0x0, 0x3, 0x7a,0x35,0x2e,0x22,0x7e,0x34,0x0, 0x4, 0x7a,0x35,0x2e,
0x75,0x16,0x0, 0x22,0xca,0x3b,0x7a,0x15,0x8, 0x7f,0x31,0x7e,0x35,0x8, 0xbe,0x34,
0x0, 0x0, 0x38,0x4f,0x7e,0x34,0xff,0xff,0x7a,0x35,0x8, 0x75,0xe, 0x1, 0x80,0x43,
0x7e,0x34,0x0, 0x80,0x7a,0x35,0x11,0x7f,0x13,0x7e,0x8, 0x2, 0x56,0x12,0xc, 0xe3,
0x7e,0x35,0x8, 0x9e,0x34,0x0, 0x80,0x7a,0x35,0x8, 0x2e,0x38,0x0, 0x80,0x6d,0x33,
0x7a,0x35,0xf, 0x7e,0x35,0xf, 0x9, 0x63,0x2, 0x56,0x7e,0xd, 0xa, 0x7e,0xb, 0x70,
0x6c,0x76,0x7a,0xb, 0x70,0x7e,0x35,0xf, 0xb, 0x34,0x7a,0x35,0xf, 0xbe,0x34,0x0, 
0x80,0x78,0xe0,0x7e,0x35,0x8, 0xbe,0x34,0x0, 0x80,0x38,0xb4,0xe5,0xe, 0x60,0x5, 
0xb, 0x34,0x7a,0x35,0x8, 0x7e,0x35,0x8, 0x7a,0x35,0x11,0x7f,0x13,0x7e,0x8, 0x2, 
0x56,0x12,0xc, 0xe3,0x6d,0x33,0x80,0x17,0x7e,0x35,0xf, 0x9, 0x63,0x2, 0x56,0x7e,
0xd, 0xa, 0x7e,0xb, 0x70,0x6c,0x76,0x7a,0xb, 0x70,0x7e,0x35,0xf, 0xb, 0x34,0x7a,
0x35,0xf, 0x7e,0x35,0x8, 0xbe,0x35,0xf, 0x38,0xde,0xda,0x3b,0x22,0x80,0x18,0x0, 
0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xe5,0x3d,0x70,0xa, 0x0, 0x0, 0x0, 
0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x7d,0x23,0x1b,0x34,0x4d,0x22,0x78,0xe0,0x22,
0x56,0x30,0x2e,0x35,0x5f,0x41,0x70,0x72,0x20,0x33,0x30,0x20,0x32,0x30,0x32,0x30,
0x46,0x54,0x53,0x36,0x32,0x31,0x36,0x5f,0x50,0x72,0x61,0x6d,0x62,0x6f,0x6f,0x74,
0x12,0xc, 0x62,0x2, 0x5, 0x6f,0x7e,0x35,0x2e,0x1b,0x34,0x68,0x57,0x1b,0x35,0x78,
0x3, 0x2, 0x4, 0xb3,0x1b,0x34,0x78,0x3, 0x2, 0x4, 0xe0,0xb, 0x35,0x68,0x3, 0x2, 
0x5, 0x5b,0x6d,0x33,0x7a,0x35,0x2e,0x7a,0x35,0x30,0x30,0x5, 0x5, 0x12,0xc, 0xd2,
0xc2,0x5, 0x7e,0xd, 0x33,0x69,0x30,0x0, 0x4, 0x7a,0x35,0xc, 0x69,0x30,0x0, 0x2, 
0xb, 0xa, 0x20,0x2e,0x14,0x0, 0x8, 0x12,0x0, 0x46,0xd2,0x5, 0x7e,0x2d,0x33,0x69,
0x12,0x0, 0x4, 0x69,0x32,0x0, 0x2, 0xb, 0x2a,0x20,0x12,0xa, 0x5a,0x2e,0x34,0x10,
0x0, 0x2, 0x5, 0x58,0x6d,0x33,0x7a,0x35,0x2e,0x7e,0x34,0x1, 0x0, 0x7a,0x35,0x11,
0x7e,0xd, 0x33,0x69,0x30,0x0, 0x2, 0xb, 0xa, 0x20,0x2e,0x14,0x0, 0x8, 0x12,0xc, 
0xe3,0x20,0x0, 0x3, 0x2, 0x5, 0x5b,0x7e,0x1d,0x33,0x29,0xb1,0x0, 0x8, 0xf5,0x91,
0x2, 0x5, 0x5b,0x6d,0x33,0x7a,0x35,0x2e,0x7a,0x35,0x30,0x7e,0x2d,0x33,0x69,0x12,
0x0, 0x4, 0x7a,0x15,0x1b,0x7e,0x18,0x0, 0x16,0x7a,0x1d,0xa, 0x69,0x32,0x0, 0x2, 
0xb, 0x2a,0x20,0x12,0x3, 0x34,0x12,0xc, 0xd2,0x7e,0x34,0xf0,0x55,0x2, 0x5, 0x58,
0x6d,0x33,0x7a,0x35,0x2e,0x7a,0x35,0x30,0xe5,0x37,0xb4,0xa, 0x1f,0xe5,0x23,0xb4,
0x80,0x15,0xe4,0x12,0xa, 0xf8,0x7e,0xe0,0x10,0x7c,0xbe,0x12,0x5, 0x76,0xb, 0xe0,
0xbe,0xe0,0x1c,0x78,0xf4,0x80,0x4a,0x12,0x6, 0xe1,0x80,0x45,0xe5,0x37,0xb4,0xb, 
0x25,0xe5,0x23,0xb4,0x80,0x10,0x6c,0xff,0x7c,0xbf,0x12,0x5, 0x76,0xb, 0xf0,0xbe,
0xf0,0x8, 0x78,0xf4,0x80,0x2b,0x6c,0xff,0x7c,0xbf,0x12,0x5, 0x76,0xb, 0xf0,0xbe,
0xf0,0x20,0x78,0xf4,0x80,0x1b,0xe5,0x37,0xa, 0x6b,0x9e,0x64,0x0, 0x80,0x6c,0xcc,
0x80,0x9, 0x7c,0xbd,0x12,0x5, 0x76,0xb, 0xd0,0xb, 0xc0,0xe5,0x22,0xbc,0xbc,0x38,
0xf1,0x12,0xc, 0xd2,0x7e,0x34,0xf0,0xaa,0x7a,0x35,0x30,0x30,0x4, 0x11,0x7e,0x34,
0x13,0x88,0x12,0x3, 0xdd,0x7e,0x34,0x13,0x88,0x12,0x3, 0xdd,0x75,0xe9,0xff,0x30,
0x6, 0x3, 0x2, 0x4, 0x26,0x22,0xca,0xf8,0x7c,0xfb,0xe5,0x23,0xb4,0x80,0x4a,0xd2,
0x7, 0x12,0xc, 0xbf,0x74,0x20,0xca,0xb8,0xa, 0x3f,0x6d,0x22,0x74,0xc, 0x2f,0x11,
0x14,0x78,0xfb,0xda,0xb8,0x12,0xc, 0xa, 0xa9,0xd2,0xb4,0x12,0xd, 0x2d,0x12,0x0, 
0x2e,0x50,0x9, 0x7e,0x35,0x19,0xbe,0x34,0x1, 0xf4,0x28,0xf2,0x7e,0x35,0x19,0xbe,
0x34,0x1, 0xf4,0x38,0x6, 0x12,0xd, 0x4f,0x2, 0x6, 0x48,0xc2,0x86,0x7e,0x34,0x13,
0x88,0x12,0x3, 0xdd,0xd2,0x86,0x2, 0x6, 0x48,0x74,0x1, 0x12,0x9, 0x40,0x74,0x1, 
0x6d,0x33,0x12,0xa, 0xad,0xe4,0x12,0x9, 0xa8,0x5e,0x34,0x80,0x0, 0x7c,0x4f,0x6c,
0x55,0x3e,0x24,0x4d,0x32,0x12,0xa, 0xad,0x74,0x4, 0x6d,0x33,0x12,0xa, 0xad,0x7e,
0x34,0x0, 0x50,0x12,0xa, 0xad,0x7e,0x34,0x0, 0x19,0x12,0x3, 0xdd,0x74,0x4, 0x7e,
0x34,0x0, 0x51,0x12,0xa, 0xad,0x7e,0x34,0xa2,0x1c,0x12,0x3, 0xdd,0x74,0x4, 0x7e,
0x34,0x0, 0x11,0x12,0xa, 0xad,0x7e,0x34,0x0, 0x19,0x12,0x3, 0xdd,0x74,0x4, 0x7e,
0x34,0x0, 0x10,0x12,0xa, 0xad,0x7e,0x34,0x0, 0x19,0x12,0x3, 0xdd,0x74,0x4, 0x6d,
0x33,0x12,0xa, 0xad,0x7e,0x34,0x0, 0x5, 0x12,0x3, 0xdd,0xe4,0x12,0x9, 0x40,0x74,
0x4, 0x7e,0x34,0xff,0xf7,0x12,0xa, 0xad,0xda,0xf8,0x22,0xca,0x3b,0x7f,0x30,0x7c,
0xb6,0xf5,0x12,0x7c,0xb7,0xf5,0x13,0x74,0x1, 0x7e,0x35,0x10,0x1e,0x34,0x1b,0x34,
0x4e,0x60,0x80,0x12,0xa, 0xad,0x12,0x9, 0x40,0xa9,0xc2,0xb4,0xa9,0xc6,0xb3,0x75,
0xb5,0x2, 0xa9,0x36,0xb3,0xfc,0xa9,0xc6,0xb3,0x75,0xb5,0x0, 0xa9,0x36,0xb3,0xfc,
0xa9,0xc6,0xb3,0x85,0x12,0xb5,0xa9,0x36,0xb3,0xfc,0xa9,0xc6,0xb3,0x85,0x13,0xb5,
0xa9,0x36,0xb3,0xfc,0xa9,0xc6,0xb3,0x6d,0x33,0x80,0x2a,0x7f,0x13,0x2e,0x35,0x14,
0x7e,0x1b,0xb0,0xf5,0xb5,0xa9,0x36,0xb3,0xfc,0xa9,0xc6,0xb3,0x7e,0x35,0x14,0x5e,
0x34,0x0, 0x1, 0xbe,0x34,0x0, 0x1, 0x78,0x7, 0x7e,0x34,0x0, 0x78,0x12,0x3, 0xdd,
0x7e,0x35,0x14,0xb, 0x34,0x7a,0x35,0x14,0x7e,0x35,0x10,0xbe,0x35,0x14,0x38,0xcb,
0xa9,0xd2,0xb4,0x7e,0x34,0x0, 0x5, 0x12,0x3, 0xdd,0xe4,0x12,0x9, 0x40,0xda,0x3b,
0x22,0xe5,0x23,0xb4,0x80,0x16,0xd2,0x7, 0x12,0xc, 0xbf,0xa9,0xc2,0xb4,0x74,0x60,
0x12,0xd, 0x18,0xa9,0xd2,0xb4,0x12,0x0, 0x2e,0x40,0xfb,0x22,0x74,0x1, 0x12,0x9, 
0x40,0xe4,0x6d,0x33,0x12,0xa, 0xad,0x74,0x1, 0x6d,0x33,0x12,0xa, 0xad,0x74,0x4, 
0x6d,0x33,0x12,0xa, 0xad,0x7e,0x34,0x0, 0x54,0x12,0xa, 0xad,0x7e,0x34,0x0, 0x19,
0x12,0x3, 0xdd,0x74,0x4, 0x7e,0x34,0x0, 0x55,0x12,0xa, 0xad,0x7e,0x34,0xa2,0x1c,
0x12,0x3, 0xdd,0x74,0x4, 0x7e,0x34,0x0, 0x15,0x12,0xa, 0xad,0x7e,0x34,0x0, 0xa0,
0x12,0x3, 0xdd,0x74,0x4, 0x7e,0x34,0x0, 0x14,0x12,0xa, 0xad,0x7e,0x34,0x0, 0x19,
0x12,0x3, 0xdd,0x74,0x4, 0x7e,0x34,0x0, 0x4, 0x12,0xa, 0xad,0x7e,0x34,0x0, 0x5, 
0x12,0x3, 0xdd,0xe4,0x12,0x9, 0x40,0x74,0x4, 0x7e,0x34,0xff,0xf7,0x2, 0xa, 0xad,
0x75,0x84,0x1, 0x7e,0x44,0x1f,0xff,0xe4,0x7a,0x49,0xb0,0x1b,0x44,0x78,0xf9,0x7e,
0xf8,0x3, 0x19,0xd2,0x5, 0x75,0x1b,0x0, 0x75,0x1c,0x0, 0xc2,0x6, 0x75,0x16,0x0, 
0x75,0x17,0x62,0x75,0x18,0x1a,0x75,0x19,0x0, 0x75,0x1a,0x0, 0xd2,0x0, 0xc2,0x2, 
0xc2,0x3, 0xc2,0x4, 0x75,0x21,0x0, 0x75,0x22,0x0, 0x75,0x23,0x80,0x75,0x2e,0x0, 
0x75,0x2f,0x0, 0x75,0x30,0x0, 0x75,0x31,0x0, 0x75,0x32,0x0, 0x75,0x37,0xb, 0x75,
0x38,0x0, 0x75,0x3d,0x1, 0x7e,0x4, 0x0, 0xff,0x7e,0x14,0xd, 0x52,0xb, 0xa, 0x40,
0x5d,0x44,0x68,0x1a,0x69,0x20,0x0, 0x2, 0xb, 0xe, 0xb, 0x44,0x80,0xa, 0x7e,0xb, 
0xb0,0x7a,0x29,0xb0,0xb, 0x24,0xb, 0xc, 0x1b,0x44,0x78,0xf2,0x80,0xdf,0x2, 0x4, 
0x20,0xca,0xf8,0x7e,0xf0,0x70,0xc2,0x7, 0x75,0x91,0x0, 0xc2,0x90,0xc2,0x91,0x30,
0x6, 0x4e,0x7e,0x34,0x0, 0x6, 0x7a,0x35,0x11,0x7e,0x18,0xff,0xb0,0x7e,0x8, 0x2, 
0xd6,0x12,0xc, 0xe3,0x7e,0xb3,0x2, 0xd6,0x7e,0x73,0x2, 0xd7,0x12,0xc, 0xa5,0x92,
0x7, 0x30,0x7, 0x6, 0x7e,0xf3,0x2, 0xd6,0x80,0x26,0x7e,0x34,0x0, 0x6, 0x7a,0x35,
0x11,0x7e,0x18,0x1, 0x20,0x7e,0x8, 0x2, 0xf6,0x12,0xc, 0xe3,0x7e,0xb3,0x2, 0xf6,
0x7e,0x73,0x2, 0xf7,0x12,0xc, 0xa5,0x92,0x7, 0x30,0x7, 0x4, 0x7e,0xf3,0x2, 0xf6,
0x5e,0xf0,0xfe,0x7a,0xf1,0x92,0xd2,0xe8,0xc2,0xc0,0xa9,0xd5,0xb7,0xd2,0xbd,0xd2,
0xad,0xda,0xf8,0x22,0xca,0x79,0x7d,0x73,0x12,0xd, 0x2d,0x7e,0x34,0x0, 0x1, 0x7e,
0xf, 0x3, 0x16,0x79,0x30,0x0, 0x4, 0x7e,0xf, 0x3, 0x16,0x79,0x30,0x0, 0x6, 0x7e,
0x1f,0x3, 0x16,0x69,0x11,0x0, 0x6, 0x4d,0x11,0x68,0x9, 0x7e,0x15,0x19,0xbe,0x14,
0x0, 0x3c,0x28,0xeb,0x1b,0x1a,0x70,0x7e,0xf, 0x3, 0x16,0x69,0x30,0x0, 0x8, 0x4d,
0x33,0x78,0x9, 0x7e,0x35,0x19,0xbe,0x34,0x0, 0x3c,0x28,0xeb,0x6d,0x33,0x1b,0xa, 
0x30,0x7e,0x1f,0x3, 0x16,0x69,0x11,0x0, 0x8, 0x4d,0x11,0x78,0x9, 0x7e,0x15,0x19,
0xbe,0x14,0x0, 0x3c,0x28,0xeb,0x69,0x71,0x0, 0x2, 0x12,0xd, 0x4f,0x7d,0x37,0xda,
0x79,0x22,0x7c,0x7b,0x7e,0xa0,0xef,0xe5,0x21,0x24,0xfd,0x68,0x38,0x1b,0xb1,0x68,
0x22,0x24,0x9f,0x68,0x3d,0x1b,0xb2,0x68,0x3e,0x24,0x9e,0x68,0x35,0x24,0x3c,0x78,
0x4c,0xa5,0xbf,0x0, 0x5, 0x7e,0xa1,0x17,0x80,0x43,0xa5,0xbf,0x1, 0x3f,0x7e,0xa1,
0x18,0x80,0x3a,0xa5,0xbf,0x0, 0x5, 0x7e,0xa1,0x23,0x80,0x31,0xa5,0xbf,0x1, 0x2d,
0x7e,0xa1,0x3d,0x80,0x28,0xa, 0x17,0x7e,0x1d,0x39,0x2d,0x31,0x29,0xa1,0x0, 0x8, 
0x80,0x1b,0x7e,0xa1,0x16,0x80,0x16,0xa5,0xbf,0x0, 0x9, 0x7e,0x35,0x30,0xa, 0x56,
0x7c,0xab,0x80,0x9, 0xa5,0xbf,0x1, 0x5, 0x7e,0x55,0x30,0x7c,0xab,0x7c,0xba,0x22,
0xca,0x79,0xbe,0xb0,0x0, 0x28,0x2e,0x74,0x6, 0x12,0x9, 0xa8,0x7d,0x73,0x6c,0xff,
0x7e,0xf0,0xa5,0x7d,0x37,0x12,0xa, 0xad,0x6c,0xff,0x7e,0xf0,0xf, 0x7d,0x37,0x12,
0xa, 0xad,0x6c,0xff,0x7e,0xf0,0x6a,0x7d,0x37,0x12,0xa, 0xad,0x7e,0x34,0x0, 0x5, 
0x12,0x3, 0xdd,0x80,0x30,0x74,0x1, 0x7e,0x34,0xdf,0xff,0x12,0xa, 0xad,0x74,0x6, 
0x12,0x9, 0xa8,0x7d,0x73,0x6c,0xff,0x7d,0x37,0x12,0xa, 0xad,0x7d,0x37,0x12,0xa, 
0xad,0x7d,0x37,0x12,0xa, 0xad,0x74,0x2, 0x12,0x9, 0xa8,0x7d,0x73,0x4e,0xf0,0x1, 
0x7d,0x37,0x12,0xa, 0xad,0xda,0x79,0x22,0xa9,0xc2,0xb4,0xa9,0xc6,0xb3,0x75,0xb5,
0x5, 0xa9,0x36,0xb3,0xfc,0xa9,0xc6,0xb3,0x75,0xb5,0x0, 0xa9,0x36,0xb3,0xfc,0xa9,
0xc6,0xb3,0x75,0xb5,0x0, 0xa9,0x36,0xb3,0xfc,0xa9,0xc6,0xb3,0xf5,0xb5,0xa9,0x36,
0xb3,0xfc,0xa9,0xc6,0xb3,0x75,0xb5,0x0, 0xa9,0x36,0xb3,0xfc,0xa9,0xc6,0xb3,0x75,
0xb5,0x0, 0xa9,0x36,0xb3,0xfc,0xa9,0xc6,0xb3,0x7e,0x71,0xb5,0x75,0xb5,0x0, 0xa9,
0x36,0xb3,0xfc,0xa9,0xc6,0xb3,0x7e,0xa1,0xb5,0xa9,0xd2,0xb4,0x7c,0x47,0x6c,0x55,
0xa, 0x3a,0x4d,0x32,0x22,0x7f,0x70,0xd2,0x7, 0x12,0xc, 0xbf,0x74,0x2, 0x12,0xc, 
0xa, 0x6d,0x33,0x80,0x12,0x7f,0x7, 0x2d,0x13,0x7e,0xb, 0xb0,0xf5,0xb5,0xa9,0x36,
0xb3,0xfc,0xa9,0xc6,0xb3,0xb, 0x34,0x7e,0x25,0x10,0xbd,0x23,0x38,0xe7,0xa9,0xd2,
0xb4,0x12,0xd, 0x2d,0x12,0x0, 0x2e,0x50,0x9, 0x7e,0x35,0x19,0xbe,0x34,0x1, 0xf4,
0x28,0xf2,0x7e,0x35,0x19,0xbe,0x34,0x1, 0xf4,0x38,0x3, 0x2, 0xd, 0x4f,0xc2,0x86,
0x7e,0x34,0x13,0x88,0x12,0x3, 0xdd,0xd2,0x86,0x22,0x6d,0x0, 0x74,0x10,0x4d,0x0, 
0x78,0xb, 0x4d,0x22,0x78,0x27,0x8d,0x31,0x7d,0x12,0x6d,0x22,0x22,0x7d,0x43,0x7d,
0x32,0x6d,0x22,0x2f,0x11,0x2d,0x44,0x50,0x2, 0xa5,0xf, 0xbf,0x10,0x40,0x4, 0x9f,
0x10,0xb, 0x90,0x14,0x78,0xed,0x7f,0x1, 0x6d,0x22,0x7d,0x34,0x22,0x7d,0x41,0x7d,
0x13,0x8d,0x24,0x7d,0x2, 0x2f,0x0, 0x40,0x4, 0xbd,0x4, 0x40,0x4, 0x9d,0x4, 0xb, 
0x14,0x14,0x78,0xf1,0x7d,0x23,0x7d,0x31,0x7d,0x10,0x6d,0x0, 0x22,0x7d,0x23,0xa, 
0x36,0x7c,0xa5,0xa9,0xc2,0xb4,0xa9,0xc6,0xb3,0x75,0xb5,0x1, 0xa9,0x36,0xb3,0xfc,
0xa9,0xc6,0xb3,0x75,0xb5,0x0, 0xa9,0x36,0xb3,0xfc,0xa9,0xc6,0xb3,0x75,0xb5,0x0, 
0xa9,0x36,0xb3,0xfc,0xa9,0xc6,0xb3,0xf5,0xb5,0xa9,0x36,0xb3,0xfc,0xa9,0xc6,0xb3,
0x7a,0x71,0xb5,0xa9,0x36,0xb3,0xfc,0xa9,0xc6,0xb3,0x7a,0xa1,0xb5,0xa9,0x36,0xb3,
0xfc,0xa9,0xc6,0xb3,0xa9,0xd2,0xb4,0x22,0x7c,0xab,0xd2,0x7, 0x12,0xc, 0xbf,0x74,
0xd8,0xa, 0x3a,0x7d,0x23,0x6d,0x33,0x12,0xc, 0xa, 0xa9,0xd2,0xb4,0x12,0xd, 0x2d,
0x12,0x0, 0x2e,0x50,0x9, 0x7e,0x35,0x19,0xbe,0x34,0x5, 0xdc,0x28,0xf2,0x7e,0x35,
0x19,0xbe,0x34,0x5, 0xdc,0x38,0x3, 0x2, 0xd, 0x4f,0xc2,0x86,0x7e,0x34,0x13,0x88,
0x12,0x3, 0xdd,0xd2,0x86,0x22,0xca,0x2b,0xca,0x1b,0xca,0xb, 0xd2,0x0, 0x30,0x90,
0x1c,0xc2,0x90,0x7e,0x71,0x91,0xe5,0x38,0x70,0x3, 0x7a,0x71,0x21,0xe5,0x38,0x12,
0x1, 0x20,0x5, 0x38,0x30,0x2, 0x6, 0xe4,0x12,0x8, 0xd2,0xf5,0x91,0x30,0x91,0xb, 
0xc2,0x91,0x5, 0x38,0xe5,0x38,0x12,0x8, 0xd2,0xf5,0x91,0xda,0xb, 0xda,0x1b,0xda,
0x2b,0x32,0xca,0xf8,0x7c,0xfb,0xe5,0x23,0xb4,0x81,0x23,0x74,0x2, 0x12,0x9, 0xa8,
0x4c,0xff,0x78,0x8, 0xa9,0xc0,0xca,0x5e,0x70,0xdf,0x80,0x6, 0xa9,0xd0,0xca,0x4e,
0x70,0x20,0x74,0x2, 0x12,0xa, 0xad,0x74,0x2, 0x12,0x9, 0xa8,0x80,0x8, 0xe5,0x23,
0xb4,0x80,0x3, 0x12,0xb, 0xdc,0xda,0xf8,0x22,0xd2,0x7, 0x12,0xc, 0xbf,0xa9,0xc2,
0xb4,0x74,0x9f,0x12,0xd, 0x18,0x12,0xc, 0xff,0xa9,0xd2,0xb4,0x60,0x3, 0xb4,0xff,
0x1a,0x75,0x23,0x81,0xa9,0xd5,0xca,0xa9,0xd0,0xca,0x75,0xed,0x9f,0x75,0xad,0x20,
0xa9,0xd1,0xea,0xa9,0xc1,0xea,0x74,0x1, 0x2, 0xb, 0x72,0x22,0xd2,0x7, 0x12,0xc, 
0xbf,0xa9,0xc2,0xb4,0x74,0x5, 0x12,0xd, 0x18,0x12,0xc, 0xff,0x7c,0xab,0xa9,0xd2,
0xb4,0x5e,0xa0,0xe3,0xa9,0xc2,0xb4,0x74,0x1, 0x12,0xd, 0x18,0x7c,0xba,0x12,0xd, 
0x18,0xa9,0xd2,0xb4,0x12,0x0, 0x2e,0x40,0xfb,0x22,0x7c,0xab,0x7d,0x12,0x7c,0xb3,
0xf5,0x14,0x7c,0x36,0x7c,0x25,0xa, 0x4, 0x7c,0xb3,0xf5,0x13,0x7c,0xb7,0xf5,0x12,
0xa9,0xc2,0xb4,0x7c,0xba,0x12,0xd, 0x18,0xe5,0x14,0x12,0xd, 0x18,0xe5,0x13,0x12,
0xd, 0x18,0xe5,0x12,0x2, 0xd, 0x18,0x7d,0x52,0xf5,0x15,0x7c,0xb6,0x7c,0xa5,0xa, 
0x44,0xf5,0x14,0x7f,0x21,0xf5,0x13,0xa9,0xc2,0xb4,0x74,0xb, 0x12,0xd, 0x18,0xe5,
0x15,0x12,0xd, 0x18,0xe5,0x14,0x12,0xd, 0x18,0xe5,0x13,0x12,0xd, 0x18,0xe4,0x2, 
0xd, 0x18,0x12,0xc, 0x84,0x12,0x0, 0xf9,0xa9,0xa6,0x94,0xb3,0x92,0x6, 0xd2,0x6, 
0x30,0x6, 0x6, 0x12,0xd, 0xc, 0x12,0xb, 0xa9,0x12,0x7, 0xf1,0x12,0xc, 0xf1,0xd2,
0xaf,0x2, 0xd, 0x40,0xd2,0xcf,0x85,0x3d,0xcc,0x75,0xec,0xff,0x75,0xee,0xff,0x75,
0xeb,0x3, 0x75,0xac,0x40,0xa9,0xc5,0xca,0x75,0xed,0xf, 0x75,0xad,0xb0,0xa9,0xd7,
0x94,0xa9,0xd4,0x94,0x22,0xa, 0x27,0xa, 0x3b,0x2d,0x32,0xbe,0x34,0x0, 0xff,0x78,
0xc, 0xbe,0xb0,0x2, 0x40,0x7, 0xbe,0xb0,0xfe,0x38,0x2, 0xd3,0x22,0xc3,0x22,0xa9,
0xc2,0xb4,0x30,0x7, 0x4, 0x74,0x6, 0x80,0x2, 0x74,0x4, 0x12,0xd, 0x18,0xa9,0xd2,
0xb4,0x22,0xe5,0x32,0xb4,0xc, 0xb, 0xc2,0x86,0x7e,0x34,0x0, 0x64,0x12,0x3, 0xdd,
0xd2,0x86,0x22,0x12,0xc, 0x37,0x7e,0x35,0x11,0x12,0x0, 0xe, 0xa9,0xd2,0xb4,0xd3,
0x22,0xc2,0x8c,0x43,0x89,0x2, 0x75,0x8c,0x1, 0x75,0x8a,0x0, 0xd2,0xa9,0x22,0x75,
0xb5,0x0, 0xa9,0x36,0xb3,0xfc,0xa9,0xc6,0xb3,0xe5,0xb5,0x22,0xd2,0xc8,0x75,0xb3,
0x13,0xa9,0xd1,0xb4,0xa9,0xc0,0xb4,0x22,0xf5,0xb5,0xa9,0x36,0xb3,0xfc,0xa9,0xc6,
0xb3,0xd3,0x22,0x7e,0x34,0x0, 0x4, 0x12,0x8, 0x64,0x7d,0x53,0x22,0xc2,0x8c,0x6d,
0x33,0x7a,0x35,0x19,0xd2,0x8c,0x22,0x7e,0x35,0x19,0xb, 0x34,0x7a,0x35,0x19,0x22,
0x85,0x3d,0xcc,0xe5,0x3d,0x2, 0xb, 0x72,0xa9,0xc0,0x93,0x75,0x38,0x0, 0x32,0x2, 
0xd, 0x37,0x0, 0x4, 0x3, 0x16,0x0, 0x0, 0x9c,0x0, 0x0, 0x0, 0xff,0xff,0xff,0xff,
};  




static uint8_t retryCnt;

/*
 * GLOBAL VARIABLE DEFINITIONS
 *****************************************************************************************
 */




/*
 * LOCAL FUNCTION DEFINITIONS
 *****************************************************************************************
 */

/**
 *****************************************************************************************
 * @brief 
 *
 * @param[in]
 *
 * @return 
 *****************************************************************************************
 */
uint16_t Touch_Send_nByte(uint8_t *regData,uint8_t bLen)
{
	uint16_t ret;

	for(uint8_t i = 0; i < 3; i++) 
	{
		ret = maxeye_i2c0_transmit(TOUCH_7BIT_ADDR,regData,bLen);
		if (ret==APP_DRV_SUCCESS) 
		{
			break;
		}
	}
	return ret;
}



/**
 *****************************************************************************************
 * @brief 
 *
 * @param[in]
 *
 * @return 
 *****************************************************************************************
 */
uint16_t Touch_Recv_nByte(uint8_t reg_addr, uint8_t * regData,uint8_t bLen) 
{
	uint16_t ret;

	for(uint8_t i = 0; i < 3; i++) 
	{
		ret = maxeye_i2c0_read(TOUCH_7BIT_ADDR,reg_addr,I2C_MEMADD_SIZE_8BIT,regData,bLen);
		if (ret==APP_DRV_SUCCESS) 
		{
			break;
		}
	}
	return ret;
}


/**
 *****************************************************************************************
 * @brief 
 *
 * @param[in]
 *
 * @return 
 *****************************************************************************************
 */
uint8_t fts_ecc_xor8_host(const uint8_t *pData, uint16_t len)
{
	uint8_t ecc = 0;

	for (uint16_t i = 0; i < len; i++) 
	{
		ecc ^= pData[i];
	}

	return ecc;
}

/**
 *****************************************************************************************
 * @brief 
 *
 * @param[in]
 *
 * @return 
 *****************************************************************************************
 */
void touch_soft_reset(void)
{
	uint8_t databuff[2]={0xFC,0xAA};

	Touch_Send_nByte(databuff,2);
	TOUCH_DELAY(10);
	databuff[1]=0x55;
	Touch_Send_nByte(databuff,2);
}

/**
 *****************************************************************************************
 * @brief 
 *
 * @param[in]
 *
 * @return 
 *****************************************************************************************
 */
uint16_t enter_romboot_mode(void)
{
	uint8_t databuff[2]={0x55,0xAA};

	return Touch_Send_nByte(databuff,2);
}

/**
 *****************************************************************************************
 * @brief 
 *
 * @param[in]
 *
 * @return 
 *****************************************************************************************
 */
uint16_t romboot_mode_verify(uint8_t bStatus)
{
	uint8_t databuff[2]={0x90,0};


	retryCnt=10;
	while(retryCnt)
	{
		Touch_Recv_nByte(0x90,databuff,2);
		if(databuff[0]==0x62 && databuff[1]==bStatus)
		{
     		return TOUCH_STATUS_OK;
		}
		retryCnt--;
		LOG("rbt vfy:%d\r\n",retryCnt);
		TOUCH_DELAY(20);
	}
	return READ_TOUCH_ROMBOOT_ID_FAIL;
}


/**
 *****************************************************************************************
 * @brief 
 *
 * @param[in]
 *
 * @return 
 *****************************************************************************************
 */
uint16_t write_touch_romboot(void)
{
	uint8_t i;
	uint16_t startAddr=0; 
	uint16_t rombootSize=0; 
	touch_package_t touchPackage;

	rombootSize=sizeof(PramBoot);
	LOG("romboot size:%d\r\n",rombootSize);

	touchPackage.pkHead=0xAE;
	touchPackage.pkAddH=0;
	for(i=0;i<(rombootSize/SEND_PACKAGE_SIZE);i++)
	{
		startAddr=i*SEND_PACKAGE_SIZE;
		touchPackage.pkAddM=startAddr>>8;
		touchPackage.pkAddL=startAddr;
		touchPackage.pkLenH=SEND_PACKAGE_SIZE>>8;
		touchPackage.pkLenL=SEND_PACKAGE_SIZE;
		memcpy(touchPackage.pkbuff,&PramBoot[startAddr],SEND_PACKAGE_SIZE);
		if(Touch_Send_nByte(&touchPackage.pkHead,SEND_PACKAGE_SIZE+6)!=TOUCH_STATUS_OK)
		{
			return WRITE_TOUCH_ROMBOOT_FAIL;
		}
		// delay_us(100);
	}

	if(rombootSize%SEND_PACKAGE_SIZE)
	{
		startAddr=i*SEND_PACKAGE_SIZE;
		touchPackage.pkAddM=startAddr>>8;
		touchPackage.pkAddL=startAddr;
		touchPackage.pkLenH=(rombootSize%SEND_PACKAGE_SIZE)>>8;
		touchPackage.pkLenL=(rombootSize%SEND_PACKAGE_SIZE);
		memcpy(touchPackage.pkbuff,&PramBoot[startAddr],(rombootSize%SEND_PACKAGE_SIZE));
		if(Touch_Send_nByte(&touchPackage.pkHead,((rombootSize%SEND_PACKAGE_SIZE)+6))!=TOUCH_STATUS_OK)
		{
			return WRITE_TOUCH_ROMBOOT_FAIL;
		}
	}

	return TOUCH_STATUS_OK;
}

/**
 *****************************************************************************************
 * @brief 
 *
 * @param[in]
 *
 * @return 
 *****************************************************************************************
 */
uint16_t touch_romboot_verify(uint8_t *bEcc)
{
	retryCnt=5;

   	while(retryCnt)
	{ 
		if(Touch_Recv_nByte(0xCC,bEcc,1)==TOUCH_STATUS_OK)		
		{
			return TOUCH_STATUS_OK;
		}
		retryCnt--;
		LOG("pk vfy:%d\r\n",retryCnt);
		TOUCH_DELAY(20);
	}
	return GET_TOUCH_ECC_FAIL;
}


/**
 *****************************************************************************************
 * @brief 
 *
 * @param[in]
 *
 * @return 
 *****************************************************************************************
 */
uint16_t romboot_run(void)
{
	uint8_t bCmd=0x08;

	if(Touch_Send_nByte(&bCmd,1)!=TOUCH_STATUS_OK)
	{
		return TOUCH_ROMBOOT_RUN_FAIL;
	}
	return TOUCH_STATUS_OK;
}

/**
 *****************************************************************************************
 * @brief 
 *
 * @param[in]
 *
 * @return 
 *****************************************************************************************
 */
uint16_t upgrade_erase_falsh(void)
{
	uint8_t databuff[2]={0x09,0x0B};

	if(Touch_Send_nByte(databuff,2)!=TOUCH_STATUS_OK) //erase type : erase app area
	{
		return ERASE_TOUCH_FLASH_FAIL;
	}

	databuff[0]=0x61; //erase cmd

	if(Touch_Send_nByte(databuff,1)!=TOUCH_STATUS_OK)
	{
		return ERASE_TOUCH_FLASH_FAIL;
	}

	retryCnt=5;

	while(retryCnt)
	{
		TOUCH_DELAY(100);
		Touch_Recv_nByte(0x6A,databuff,2);
		if(databuff[0]==0xF0 && databuff[1]==0xAA) //erase cmp
		{
			LOG("erase ok\r\n");
     		return TOUCH_STATUS_OK;
		}
		retryCnt--;
		LOG("erase:%d\r\n",retryCnt);
	}
	return ERASE_TOUCH_FLASH_FAIL;
}


/**
 *****************************************************************************************
 * @brief 
 *
 * @param[in]
 *
 * @return 
 *****************************************************************************************
 */
uint16_t upgrade_package_verify(uint16_t writeStatus)
{
	uint8_t  databuff[2];

	retryCnt=5;
	TOUCH_DELAY(2);

	while(retryCnt)
	{
		Touch_Recv_nByte(0x6A,databuff,2);
		if(databuff[0]==(uint8_t)(writeStatus>>8) && databuff[1]==(uint8_t)(writeStatus))
		{
			return TOUCH_STATUS_OK;
		}
		retryCnt--;
		LOG("up vfy:%d,%d,%x,%x\r\n",retryCnt,writeStatus,databuff[0],databuff[1]);
		TOUCH_DELAY(10);
	}
	return WRITE_TOUCH_FIRMWARE_FAIL;
}



/**
 *****************************************************************************************
 * @brief 
 *
 * @param[in]
 *
 * @return 
 *****************************************************************************************
 */

uint16_t upgrade_write_touch_firmware(uint32_t firmwareStartAddr)
{
	uint16_t i;

	uint16_t startAddr=0; 
	uint16_t writeStatus=0; 

	touch_package_t touchPackage;

	touchPackage.pkHead=0xBF;
	touchPackage.pkAddH=0;
	// APP_LOG_INFO("touch fw addr:%8x",firmwareStartAddr);
	for(i=0;i<=(FIRMWARE_SIZE/SEND_PACKAGE_SIZE);i++)
	{
		startAddr=i*SEND_PACKAGE_SIZE;
		touchPackage.pkAddM=startAddr>>8;
		touchPackage.pkAddL=startAddr;
		touchPackage.pkLenH=SEND_PACKAGE_SIZE>>8;
		touchPackage.pkLenL=SEND_PACKAGE_SIZE;
		hal_flash_read(firmwareStartAddr+startAddr, touchPackage.pkbuff, SEND_PACKAGE_SIZE);
		#if 0
		for(uint8_t j=0;j<SEND_PACKAGE_SIZE;j++)
		{
			printf("%02x ",touchPackage.pkbuff[j]);
			if((i%10)==0)
			{
				maxeye_wdt_refresh();
			}
		}
		#endif
		if(Touch_Send_nByte(&touchPackage.pkHead,SEND_PACKAGE_SIZE+6)!=TOUCH_STATUS_OK)
		{
			return WRITE_TOUCH_FIRMWARE_FAIL;
		}

		writeStatus=0x1000+startAddr/SEND_PACKAGE_SIZE;

		if(upgrade_package_verify(writeStatus)!=TOUCH_STATUS_OK)
		{
			return WRITE_TOUCH_FIRMWARE_FAIL;
		}
	}
	LOG("verify ok:%d\r\n",i);
	return TOUCH_STATUS_OK;
}

/**
 *****************************************************************************************
 * @brief 
 *
 * @param[in]
 *
 * @return 
 *****************************************************************************************
 */
void get_touch_firmware(uint8_t offset,uint32_t firmwareStartAddr)
{
	uint16_t startAddr=0; 
	touch_package_t touchPackage;

	touchPackage.pkHead=0xBF;
	touchPackage.pkAddH=0;
	startAddr=offset*SEND_PACKAGE_SIZE;
	touchPackage.pkAddM=startAddr>>8;
	touchPackage.pkAddL=startAddr;
	touchPackage.pkLenH=SEND_PACKAGE_SIZE>>8;
	touchPackage.pkLenL=SEND_PACKAGE_SIZE;
	hal_flash_read(firmwareStartAddr+startAddr, touchPackage.pkbuff, SEND_PACKAGE_SIZE);
	LOG("package:");
	for(uint8_t i=0;i<SEND_PACKAGE_SIZE;i++)
	{
		LOG(" %x,",touchPackage.pkbuff[i]);
	}
	LOG("\r\n");
}

/**
 *****************************************************************************************
 * @brief 
 *
 * @param[in]
 *
 * @return 
 *****************************************************************************************
 */
uint8_t fw_ecc_xor8_host(uint32_t firmwareStartAddr)
{
	uint8_t ecc = 0;
	uint8_t databuff[SEND_PACKAGE_SIZE];
	uint16_t startAddr;

	for(uint16_t i=0;i<=(FIRMWARE_SIZE/SEND_PACKAGE_SIZE);i++)
	{
		startAddr=i*SEND_PACKAGE_SIZE;
		hal_flash_read(firmwareStartAddr+startAddr,databuff, SEND_PACKAGE_SIZE);
		for (uint8_t j = 0; j < SEND_PACKAGE_SIZE; j++) 
		{
			ecc ^= databuff[j];
		}
	}
	return ecc;
}




/**
 *****************************************************************************************
 * @brief 
 *
 * @param[in]
 *
 * @return 
 *****************************************************************************************
 */
uint16_t upgrade_get_firmware_ecc(uint8_t *bEcc)
{
	uint8_t  databuff[6];

	databuff[0]=0x64;    //clear ecc

	if(	Touch_Send_nByte(databuff,1)!=TOUCH_STATUS_OK)
	{
		return GET_TOUCH_FIRMWARE_ECC_FAIL;
	}
    

	memset(databuff,0,6);

	databuff[0]=0x65;    //ecc cfg
	databuff[4]=FIRMWARE_SIZE>>8;
	databuff[5]=(uint8_t)FIRMWARE_SIZE;
	if(	Touch_Send_nByte(databuff,6)!=TOUCH_STATUS_OK)
	{
		return GET_TOUCH_FIRMWARE_ECC_FAIL;
	}

	retryCnt=5;
	TOUCH_DELAY(200);
	while(retryCnt)
	{
		Touch_Recv_nByte(0x6A,databuff,2);
		if(databuff[0]==0xF0 && databuff[1]==0x55)
		{
			break;
		}
		retryCnt--;
		LOG("get ecc:%d\r\n",retryCnt);
		TOUCH_DELAY(50);
	}

	retryCnt=5;
   	while(retryCnt)
	{ 
		if(Touch_Recv_nByte(0x66,bEcc,1)==TOUCH_STATUS_OK)
		{
			return TOUCH_STATUS_OK;
		}
		retryCnt--;
		LOG("fw vfy:%d\r\n",retryCnt);
		TOUCH_DELAY(20);
	}
	return GET_TOUCH_FIRMWARE_ECC_FAIL;
}

/**
 *****************************************************************************************
 * @brief 
 *
 * @param[in]
 *
 * @return 
 *****************************************************************************************
 */
uint16_t upgrade_reset(void)
{
	uint8_t  data;

	data=0x07;    

	if(	Touch_Send_nByte(&data,1)!=TOUCH_STATUS_OK)
	{
		return TOUCH_UPGRADE_RESET_FAIL;
	}
	return TOUCH_STATUS_OK;
}





/**
 *****************************************************************************************
 * @brief 
 *
 * @param[in]
 *
 * @return 
 *****************************************************************************************
 */
uint16_t touch_upgrade_handle(uint32_t firmwareStartAddr) //touch 升级i2c频率不支持1M
{
	uint8_t bEcc;
	uint8_t upgradeRetryCnt=4;


TOUCH_ROMNBOOT_MODE:

	maxeye_wdt_refresh();

	if(upgradeRetryCnt/2!=0)
	{
		touch_sensor_reset();
	}
	else
	{
		touch_soft_reset();
	}

	TOUCH_DELAY(15);

	if(enter_romboot_mode()!=TOUCH_STATUS_OK)
	{
		return ENTER_TOUCH_ROMBOOT_MODE_FAIL;
	}
	TOUCH_DELAY(8);
	
	if(romboot_mode_verify(0x16)!=TOUCH_STATUS_OK)
	{
		if(upgradeRetryCnt)
		{
			upgradeRetryCnt--;
			goto TOUCH_ROMNBOOT_MODE;
		}
		return READ_TOUCH_ROMBOOT_ID_FAIL;
	}

	if(write_touch_romboot()!=TOUCH_STATUS_OK)
	{
		return WRITE_TOUCH_ROMBOOT_FAIL;
	}

	if(touch_romboot_verify(&bEcc)!=TOUCH_STATUS_OK)
	{
		return GET_TOUCH_ECC_FAIL;
	}
	
	if(fts_ecc_xor8_host(PramBoot,sizeof(PramBoot))!=bEcc)
	{
		return TOUCH_ECC_VERIFY_FAIL;
	}

	if(romboot_run()!=TOUCH_STATUS_OK)
	{
		return TOUCH_ROMBOOT_RUN_FAIL;
	}

	TOUCH_DELAY(10);

	if(enter_romboot_mode()!=APP_DRV_SUCCESS)
	{
		return ENTER_TOUCH_UPGRADE_MODE_FAIL;
	}

	if(romboot_mode_verify(0x1A)!=TOUCH_STATUS_OK)
	{
		return READ_TOUCH_UPGRADE_ID_FAIL;
	}
	
    if(upgrade_erase_falsh()!=TOUCH_STATUS_OK)
	{
		return ERASE_TOUCH_FLASH_FAIL;
	}

	maxeye_wdt_refresh();
	
	if(upgrade_write_touch_firmware(firmwareStartAddr)!=TOUCH_STATUS_OK)
	{
		return WRITE_TOUCH_FIRMWARE_FAIL;
	}

	if(upgrade_get_firmware_ecc(&bEcc)!=TOUCH_STATUS_OK)
	{
		return GET_TOUCH_FIRMWARE_ECC_FAIL;
	}

	if(fw_ecc_xor8_host(firmwareStartAddr)!=bEcc)
	{
		return TOUCH_FIRMWARE_ECC_VERIFY_FAIL;	   
	}

	if(upgrade_reset()!=TOUCH_STATUS_OK)
	{
		return TOUCH_UPGRADE_RESET_FAIL;
	}
	
	return TOUCH_STATUS_OK;
}










