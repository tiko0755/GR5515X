#include "gr55xx.h"
#include "app_log.h"
#include "app_error.h"
#include "app_i2c.h"
#include "app_timer.h"


#include "bsp.h"

#include "hal_flash.h"

#include "maxeye_wdt.h"
#include "maxeye_mcu_stylus.h"
#include "maxeye_mcu_upgrade.h"


/*
 * DEFINES
 *****************************************************************************************
 */
#ifdef  UPGRADE_LOG_EN
#define LOG(format,...)  printf(format,##__VA_ARGS__) 
#else
#define LOG(format,...)  
#endif


#define MCU_DELAY_MS(X)                         delay_ms(X)

#define MCU_STATUS_OK                           0
#define ENTER_MCU_RAMCODE_MODE_FAIL             1
#define WRITE_MCU_RAMCODE_FAIL                  2
#define MCU_RAMCODE_RUN_FAIL                    3
#define MCU_ERASE_FLASH_FAIL                    4
#define MCU_BAUDRATE_SET_FAIL                   5
#define MCU_TM_ERASE_FLASH_FAIL                 6
#define MCU_TP_ERASE_FLASH_FAIL                 7
#define MCU_FLASH_CHECK_BLANK_FAIL              8
#define MCU_WRITE_FIRMWARE_FAIL                 9
#define MCU_GET_FIRMWARE_ECC_FAIL               10
#define MCU_FIRMWARE_ECC_VERIFY_FAIL            11
#define MCU_FIRMWARE_ENCRYPTION_FAIL            12
#define MCU_UPGRADE_RESET_FAIL                  13



#define MCU_ACK_SUCEESS                         1
#define MCU_ACK_FAIL                            2



#define MCU_UPGRADE_BAUDRATE                    691200
#define RAMCODE_START_ADDR                      0x20000000
#define SEND_PACKAGE_SIZE                       128
#define FIRMWARE_SIZE                           0x6000//0x8000

#define MCU_FLASH_SECTOR_SIZE                   512


enum mcu_ramcode_pk_t
{
    MCU_RAMCODE_PK_CMD,
    MCU_RAMCODE_PK_ADDR_1,
    MCU_RAMCODE_PK_ADDR_2,
    MCU_RAMCODE_PK_ADDR_3,
    MCU_RAMCODE_PK_ADDR_4,
    MCU_RAMCODE_PK_LEN_1,
    MCU_RAMCODE_PK_LEN_2,
    MCU_RAMCODE_PK_LEN_3,
    MCU_RAMCODE_PK_LEN_4,
    MCU_RAMCODE_PK_SUM_1,
};

/*
 * LOCAL VARIABLE DEFINITIONS
 *****************************************************************************************
 */
const uint8_t  RamCode[] =
{
    0xB8,0x0A,0x00,0x20,0x09,0x00,0x00,0x20,0x72,0xB6,0x03,0x48,0x01,0x68,0x81,0xF3,0x08,0x88,0x02,0x48,0x00,0x47,0x00,0x00,0x00,0x00,0x00,0x20,0x95,0x07,0x00,0x20,
    0xC0,0x68,0x01,0x68,0x6E,0x48,0x01,0x62,0x6E,0x4A,0x89,0x18,0x6E,0x4A,0x91,0x42,0x01,0xD3,0x06,0x21,0x81,0x71,0x70,0x47,0x80,0xB5,0x00,0xF0,0xE7,0xF8,0x6B,0x48,
    0x01,0x68,0x03,0x22,0x0A,0x43,0x02,0x60,0x00,0x21,0x09,0x60,0x01,0x68,0xCA,0x06,0xD2,0x0F,0xFB,0xD1,0x01,0xBD,0x10,0xB5,0x04,0x00,0x60,0x68,0x80,0x21,0x09,0x02,
    0x88,0x42,0x05,0xD3,0x62,0x49,0x40,0x18,0x80,0x21,0x89,0x00,0x88,0x42,0x10,0xD2,0x00,0xF0,0xCC,0xF8,0x5D,0x48,0x01,0x68,0x03,0x22,0x91,0x43,0x02,0x22,0x0A,0x43,
    0x02,0x60,0x00,0x21,0x62,0x68,0x11,0x60,0x01,0x68,0xCA,0x06,0xD2,0x0F,0x03,0xD0,0xFA,0xE7,0x05,0x20,0x52,0x49,0x88,0x71,0x10,0xBD,0x80,0xB5,0x01,0x00,0x4A,0x69,
    0x48,0x68,0x80,0x23,0x1B,0x02,0x9A,0x42,0x05,0xD3,0x52,0x4B,0x98,0x42,0x07,0xD3,0x51,0x4B,0x9A,0x42,0x04,0xD2,0x0A,0x89,0xC9,0x68,0x00,0xF0,0x01,0xF9,0x01,0xBD,
    0x05,0x20,0x47,0x49,0x88,0x71,0x01,0xBD,0x80,0xB5,0x01,0x89,0x44,0x4A,0x91,0x80,0x02,0x89,0xC1,0x68,0x40,0x68,0x00,0xF0,0x28,0xF9,0x01,0xBD,0x1C,0xB5,0x00,0x21,
    0x6A,0x46,0x11,0x80,0xC1,0x68,0x09,0x68,0x40,0x68,0x3D,0x4C,0x42,0x18,0x52,0x1E,0x80,0x23,0x1B,0x02,0x9A,0x42,0x02,0xD3,0x05,0x20,0xA0,0x71,0x02,0xE0,0x6A,0x46,
    0x00,0xF0,0xBF,0xF8,0x3D,0x48,0x69,0x46,0x09,0x88,0x01,0x72,0x69,0x46,0x09,0x88,0x09,0x0A,0x41,0x72,0x02,0x20,0xA0,0x80,0x13,0xBD,0x7C,0xB5,0x00,0x22,0x00,0x92,
    0xC1,0x68,0x09,0x68,0x2E,0x4E,0x01,0x25,0xB5,0x80,0x34,0x4C,0x22,0x72,0x6A,0x46,0x40,0x68,0x00,0xF0,0xB3,0xF8,0x00,0x28,0x02,0xD0,0x00,0x98,0x30,0x60,0x73,0xBD,
    0x25,0x72,0x73,0xBD,0x01,0x20,0x26,0x49,0x88,0x80,0x2C,0x49,0x2C,0x4A,0x12,0x78,0xFF,0x2A,0x00,0xD1,0x00,0x20,0x08,0x72,0x70,0x47,0x80,0xB5,0xEE,0x20,0x69,0x46,
    0x08,0x70,0x01,0x22,0x26,0x48,0x00,0xF0,0xAB,0xF8,0x01,0x22,0x69,0x46,0x25,0x48,0x00,0xF0,0xA6,0xF8,0x01,0xBD,0x70,0x47,0x10,0xB5,0x19,0x4C,0x10,0xE0,0x02,0x20,
    0xA0,0x71,0x20,0x00,0x00,0xF0,0x52,0xF9,0xA0,0x88,0x00,0xF0,0x6E,0xF9,0x60,0x7A,0x01,0x28,0x05,0xD1,0xA0,0x79,0x00,0x28,0x02,0xD1,0x20,0x6A,0x00,0xF0,0x8A,0xF9,
    0x00,0xF0,0x6B,0xF9,0x00,0xF0,0xEE,0xF8,0x01,0x28,0xF9,0xD1,0x18,0x21,0x20,0x00,0x08,0x30,0x00,0xF0,0xC5,0xF9,0x20,0x00,0x08,0x30,0x00,0xF0,0xFA,0xF8,0xA0,0x71,
    0xE1,0x68,0x21,0x60,0x00,0x21,0xA1,0x80,0x00,0x28,0xDA,0xD1,0x0E,0x48,0x61,0x7A,0x89,0x00,0x41,0x58,0x00,0x29,0xD2,0xD0,0x20,0x00,0x08,0x30,0x88,0x47,0xD0,0xE7,
    0x10,0x0A,0x00,0x20,0x80,0xDA,0xFF,0xFF,0xC1,0x1C,0x0F,0x00,0x20,0x00,0x02,0x40,0x00,0xF6,0xEF,0xFF,0x00,0x0A,0x10,0x00,0x00,0x0C,0x10,0x00,0x04,0x08,0x00,0x20,
    0xFC,0x0B,0x10,0x00,0xF6,0x0B,0x10,0x00,0xD4,0x06,0x00,0x20,0x4D,0x48,0x4E,0x49,0x01,0x60,0x4E,0x49,0x01,0x60,0x70,0x47,0x10,0xB5,0x4D,0x49,0x4A,0x4A,0xCA,0x62,
    0x4A,0x4B,0xCB,0x62,0x44,0x01,0x0C,0x60,0xCA,0x62,0xCB,0x62,0x17,0x24,0x44,0x43,0x4C,0x60,0xCA,0x62,0xCB,0x62,0x1B,0x24,0x44,0x43,0x8C,0x60,0xCA,0x62,0xCB,0x62,
    0x44,0x4C,0x44,0x43,0xCC,0x60,0xCA,0x62,0xCB,0x62,0x43,0x4C,0x44,0x43,0x0C,0x61,0xCA,0x62,0xCB,0x62,0x18,0x24,0x44,0x43,0x4C,0x61,0xCA,0x62,0xCB,0x62,0xF0,0x24,
    0x44,0x43,0x8C,0x61,0xCA,0x62,0xCB,0x62,0xFA,0x24,0xA4,0x00,0x60,0x43,0xC8,0x61,0xCA,0x62,0xCB,0x62,0x00,0x20,0x08,0x62,0xCA,0x62,0xCB,0x62,0x37,0x48,0x08,0x63,
    0x10,0xBD,0x30,0xB5,0x00,0x23,0x00,0x24,0x03,0xE0,0x05,0x78,0x5B,0x19,0x40,0x1C,0x64,0x1C,0x8C,0x42,0xF9,0xD3,0x13,0x80,0x00,0x20,0x30,0xBD,0x30,0xB5,0x03,0x00,
    0x00,0x24,0x00,0xE0,0x64,0x1C,0x8C,0x42,0x08,0xD2,0x1D,0x00,0x6B,0x1C,0x2D,0x78,0xFF,0x2D,0xF7,0xD0,0x00,0x19,0x10,0x60,0x01,0x20,0x30,0xBD,0x00,0x20,0x30,0xBD,
    0x70,0xB4,0x27,0x4B,0x20,0x4C,0xDC,0x60,0x20,0x4C,0xDC,0x60,0x01,0x24,0x1D,0x68,0x03,0x26,0xB5,0x43,0x25,0x43,0x1D,0x60,0x00,0x26,0xB6,0x18,0xB6,0x08,0xB6,0x00,
    0x95,0x1B,0x10,0xD1,0x85,0x07,0x0E,0xD1,0x15,0x00,0x18,0xD0,0x1D,0x4D,0x1E,0x68,0x36,0x09,0x26,0x40,0xFB,0xD1,0x0E,0x68,0x06,0x60,0x09,0x1D,0x00,0x1D,0x52,0x19,
    0x16,0x04,0xF4,0xD1,0x0B,0xE0,0x15,0x00,0x09,0xD0,0x1D,0x68,0x2D,0x09,0x25,0x40,0xFB,0xD1,0x0D,0x78,0x05,0x70,0x49,0x1C,0x40,0x1C,0x52,0x1E,0xF5,0xD1,0x18,0x68,
    0x00,0x09,0x20,0x40,0xFB,0xD1,0x70,0xBC,0x70,0x47,0x10,0xB5,0x00,0x23,0x04,0xE0,0x04,0x78,0x0C,0x70,0x40,0x1C,0x49,0x1C,0x5B,0x1C,0x9C,0xB2,0x94,0x42,0xF7,0xD3,
    0x00,0x20,0x10,0xBD,0x2C,0x00,0x02,0x40,0x5A,0x5A,0x00,0x00,0xA5,0xA5,0x00,0x00,0x00,0x00,0x02,0x40,0x50,0x46,0x00,0x00,0xE0,0x22,0x02,0x00,0xFF,0xFF,0x00,0x00,
    0x20,0x00,0x02,0x40,0xFC,0xFF,0x00,0x00,0x10,0xB5,0x0A,0x00,0x00,0x21,0x00,0x23,0x03,0xE0,0x04,0x78,0x09,0x19,0x40,0x1C,0x5B,0x1C,0x9C,0xB2,0x94,0x42,0xF8,0xD3,
    0xC8,0xB2,0x10,0xBD,0x48,0x48,0x01,0x88,0x09,0x29,0x0B,0xDB,0x47,0x49,0x4A,0x78,0x05,0x2A,0x09,0xD0,0x8A,0x79,0xC9,0x79,0x09,0x02,0x11,0x43,0x09,0x31,0x00,0x88,
    0x81,0x42,0x04,0xD0,0x00,0x20,0x70,0x47,0x00,0x88,0x09,0x28,0xFA,0xD1,0x01,0x20,0x70,0x47,0x38,0xB5,0x04,0x00,0x00,0x20,0x00,0x25,0x3B,0x4A,0x11,0x88,0x10,0x80,
    0x3A,0x48,0x02,0x78,0x22,0x70,0x42,0x78,0x62,0x70,0x82,0x78,0xC3,0x78,0x1B,0x02,0x13,0x43,0x02,0x79,0x12,0x04,0x1A,0x43,0x43,0x79,0x1B,0x06,0x13,0x43,0x63,0x60,
    0x83,0x79,0xC2,0x79,0x12,0x02,0x1A,0x43,0x22,0x81,0x63,0x68,0x9B,0x18,0x5B,0x1E,0x63,0x61,0x23,0x78,0x49,0x2B,0x16,0xD1,0x63,0x78,0x0B,0x2B,0x01,0xDA,0x00,0x2B,
    0x01,0xD1,0x02,0x25,0x10,0xE0,0x00,0x2A,0x02,0xD0,0x02,0x00,0x08,0x32,0xE2,0x60,0x42,0x18,0x52,0x1E,0x12,0x78,0x22,0x74,0x49,0x1E,0x89,0xB2,0xFF,0xF7,0xA4,0xFF,
    0x21,0x7C,0x88,0x42,0x00,0xD0,0x01,0x25,0x28,0x00,0x32,0xBD,0x38,0xB5,0x04,0x00,0x1E,0x4D,0xA0,0x79,0x68,0x70,0x20,0x68,0xA8,0x70,0x20,0x68,0x00,0x0A,0xE8,0x70,
    0x20,0x68,0x00,0x0C,0x28,0x71,0x20,0x68,0x00,0x0E,0x68,0x71,0xA0,0x88,0xA8,0x71,0xA0,0x88,0x00,0x0A,0xE8,0x71,0xA1,0x88,0x08,0x31,0x89,0xB2,0x28,0x00,0xFF,0xF7,
    0x83,0xFF,0xA1,0x88,0x69,0x18,0x08,0x72,0x31,0xBD,0x80,0xB5,0x01,0x00,0x09,0x31,0x89,0xB2,0x0E,0x48,0x00,0xF0,0x38,0xF8,0x01,0xBD,0x38,0xB5,0x00,0xF0,0x48,0xF8,
    0x00,0x23,0x09,0x49,0x0A,0x88,0x00,0x2A,0x01,0xD1,0x49,0x28,0x0A,0xD1,0x07,0x4A,0x0C,0x88,0x07,0x4D,0xAC,0x42,0x04,0xDA,0x0B,0x88,0x5C,0x1C,0x0C,0x80,0xD0,0x54,
    0x31,0xBD,0x13,0x70,0x0B,0x80,0x31,0xBD,0x34,0x0A,0x00,0x20,0x04,0x08,0x00,0x20,0x09,0x02,0x00,0x00,0x30,0xB5,0x00,0x21,0x00,0x22,0x09,0x4B,0xD4,0xB2,0xA5,0x00,
    0x5D,0x59,0xA8,0x42,0x0A,0xD0,0x52,0x1C,0xD4,0xB2,0x0C,0x2C,0xF6,0xDB,0x00,0xBF,0x15,0xA0,0x40,0x5A,0x03,0x49,0x08,0x60,0x48,0x60,0x30,0xBD,0x61,0x00,0xF6,0xE7,
    0x74,0x06,0x00,0x20,0x00,0x0C,0x00,0x40,0x30,0xB5,0x00,0x22,0x80,0x23,0xDB,0x05,0x0A,0xE0,0x04,0x5D,0x1C,0x60,0x1C,0x69,0xA5,0x07,0xED,0x0F,0xFB,0xD0,0x5C,0x69,
    0x02,0x25,0xAC,0x43,0x5C,0x61,0x52,0x1C,0x94,0xB2,0x8C,0x42,0xF1,0xD3,0x30,0xBD,0x80,0x20,0xC0,0x05,0x01,0x69,0xC9,0x07,0xFC,0xD5,0x41,0x69,0x01,0x22,0x91,0x43,
    0x41,0x61,0x00,0x68,0xC0,0xB2,0x70,0x47,0x70,0xFF,0xA0,0xFF,0xB8,0xFF,0xDC,0xFF,0xE8,0xFF,0xF4,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0xFA,0xFF,0xFD,0xFF,0xFE,0xFF,
    0x00,0x22,0x00,0xBF,0x09,0x42,0x02,0xD0,0x49,0x1E,0x42,0x54,0xFC,0xD1,0x70,0x47,0xF8,0xB5,0x2D,0x4C,0x2D,0x48,0xA0,0x60,0x2D,0x4D,0xA5,0x60,0x20,0x68,0xE0,0x21,
    0x49,0x00,0x01,0x43,0x21,0x60,0x2B,0x48,0x2B,0x49,0x82,0x88,0x0A,0x40,0xE2,0x60,0x42,0x88,0x0A,0x40,0xE2,0x60,0x00,0x88,0x01,0x40,0xE1,0x60,0x23,0x48,0xA0,0x60,
    0xA5,0x60,0x20,0x68,0x25,0x49,0x01,0x40,0x21,0x60,0x06,0x20,0xFF,0xF7,0x44,0xFE,0x00,0x21,0x23,0x48,0x01,0x60,0x03,0x20,0x22,0x4A,0x23,0x4B,0x23,0x4E,0x27,0x6A,
    0xFF,0x07,0x26,0x62,0x13,0xD5,0x19,0x4E,0xA6,0x60,0xA5,0x60,0x65,0x68,0x96,0x0D,0x2E,0x43,0x66,0x60,0x05,0x24,0x1C,0x60,0x15,0x68,0x80,0x26,0x2E,0x43,0x16,0x60,
    0xD1,0x64,0x9C,0x62,0x11,0x6C,0x02,0x23,0x99,0x43,0x11,0x64,0x0A,0xE0,0x98,0x63,0x14,0x6C,0x20,0x25,0xAC,0x43,0x14,0x64,0xD1,0x64,0xD8,0x63,0x11,0x6C,0x40,0x23,
    0x0B,0x43,0x13,0x64,0x12,0x49,0x13,0x4A,0x0A,0x60,0x4A,0x60,0xC8,0x60,0x0C,0x48,0x90,0x21,0x89,0x00,0x01,0x60,0x01,0x68,0x10,0x22,0x0A,0x43,0x02,0x60,0xFF,0xF7,
    0xBB,0xFD,0x00,0x20,0xF2,0xBD,0x00,0xBF,0x00,0x20,0x00,0x40,0x5A,0x5A,0x00,0x00,0xA5,0xA5,0x00,0x00,0x02,0x0C,0x10,0x00,0xFF,0x07,0x00,0x00,0x3F,0xFE,0xFF,0xFF,
    0x04,0x00,0x00,0x40,0x80,0x0D,0x02,0x40,0x9C,0x0C,0x02,0x40,0x01,0x01,0x00,0xF0,0x00,0x0C,0x00,0x40,0x70,0xFF,0x00,0x00,0x70,0xB4,0x01,0x23,0x00,0x24,0x13,0xE0,
    0x01,0x68,0x00,0x1D,0x19,0x42,0x02,0xD0,0x4D,0x46,0x6D,0x1E,0x49,0x19,0x0C,0x60,0x09,0x1D,0x12,0x1F,0x04,0x2A,0xFA,0xD2,0x0D,0x00,0x96,0x07,0x01,0xD5,0x0C,0x80,
    0xAD,0x1C,0x1A,0x40,0x00,0xD0,0x2C,0x70,0x02,0x68,0x00,0x1D,0x00,0x2A,0xE7,0xD1,0x70,0xBC,0x70,0x47,0x80,0x25,0x00,0x00,0x40,0x38,0x00,0x00,0x00,0x4B,0x00,0x00,
    0x00,0x96,0x00,0x00,0x00,0xE1,0x00,0x00,0x00,0xC2,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x84,0x03,0x00,0x00,0x08,0x07,0x00,
    0x00,0x8C,0x0A,0x00,0x30,0xB4,0x01,0x22,0x01,0x68,0x00,0x1D,0x00,0x29,0x0F,0xD0,0x03,0x68,0xC3,0x18,0x44,0x68,0x08,0x30,0x14,0x42,0x02,0xD0,0x4D,0x46,0x6D,0x1E,
    0x64,0x19,0x1D,0x68,0x25,0x60,0x1B,0x1D,0x24,0x1D,0x09,0x1F,0xEC,0xD0,0xF8,0xE7,0x30,0xBC,0x70,0x47,0x00,0x00,0x00,0x00,0x21,0x00,0x00,0x20,0x39,0x00,0x00,0x20,
    0x57,0x00,0x00,0x20,0x9B,0x00,0x00,0x20,0xC9,0x00,0x00,0x20,0xDD,0x00,0x00,0x20,0x1B,0x01,0x00,0x20,0x45,0x01,0x00,0x20,0x5B,0x01,0x00,0x20,0x77,0x01,0x00,0x20,
    0x10,0xB5,0x07,0x49,0x79,0x44,0x18,0x31,0x06,0x4C,0x7C,0x44,0x16,0x34,0x04,0xE0,0x08,0x1D,0x0A,0x68,0x89,0x18,0x88,0x47,0x01,0x00,0xA1,0x42,0xF8,0xD1,0x10,0xBD,
    0x08,0x00,0x00,0x00,0x28,0x00,0x00,0x00,0x11,0xFF,0xFF,0xFF,0x34,0x02,0x00,0x00,0x04,0x08,0x00,0x20,0x00,0x00,0x00,0x00,0x6D,0xFF,0xFF,0xFF,0x04,0x00,0x00,0x00,
    0x60,0x00,0x00,0x00,0x00,0x08,0x00,0x20,0x00,0x00,0x00,0x00,0x01,0x20,0xC0,0x46,0x00,0x28,0x01,0xD0,0xFF,0xF7,0xD4,0xFF,0x00,0xBF,0x00,0xBF,0x00,0x20,0x00,0xBF,
    0x00,0xBF,0xFF,0xF7,0xF5,0xFE,0x00,0xF0,0x00,0xF8,0x80,0xB5,0x00,0xF0,0x02,0xF8,0x01,0xBD,0x00,0x00,0x07,0x46,0x38,0x46,0x00,0xF0,0x02,0xF8,0xFB,0xE7,0x00,0x00,
    0x80,0xB5,0x00,0xBF,0x00,0xBF,0x02,0x4A,0x11,0x00,0x18,0x20,0xAB,0xBE,0xFB,0xE7,0x26,0x00,0x02,0x00,0x00,0xBF,0x00,0xBF,0x00,0xBF,0x00,0xBF,0xFF,0xF7,0xD6,0xFF,
    0x00,0x00,0x00,0x00,
};

/*
 * GLOBAL VARIABLE DEFINITIONS
 *****************************************************************************************
 */




/*
 * LOCAL FUNCTION DEFINITIONS
 *****************************************************************************************
 */
static uint16_t firmwareCheckSum;


/**
 *****************************************************************************************
 * @brief 
 *
 * @param[in]
 *
 * @return 
 *****************************************************************************************
 */
uint16_t get_mcu_sum_check(uint8_t *pData,uint16_t size)
{
    uint16_t sumcheck=0;

    for(uint16_t i=0;i<size;i++)
    {
        sumcheck+=pData[i];
    }

    return sumcheck;
}




/**
 *****************************************************************************************
 * @brief 
 *
 * @param[in]
 *
 * @return 
 *****************************************************************************************
 */
uint16_t mcu_enter_romboot(void)
{
    uint8_t bData;
    uint8_t bRetry=5;

    mcu_reset_control();

    MCU_DELAY_MS(2);

    while(bRetry--)
    {
        bData=0x18;
        app_uart_transmit_sync(APP_UART_ID_1,&bData,1,100);
        app_uart_receive_sync(APP_UART_ID_1,&bData,1,2);
        if(bData==0x11)
        {
            return MCU_STATUS_OK;
        }
    }
    return ENTER_MCU_RAMCODE_MODE_FAIL;
}









/**
 *****************************************************************************************
 * @brief 
 *
 * @param[in]
 *
 * @return 
 *****************************************************************************************
 */
uint16_t write_mcu_ramcode(void)
{
    uint8_t i;
    uint8_t mcusum=0;
    uint8_t mcupk[SEND_PACKAGE_SIZE+1];
    uint16_t pksize;
    uint16_t startAddr=0; 
    uint16_t ramcodeSize=0; 

    ramcodeSize=sizeof(RamCode);
    pksize=ramcodeSize%SEND_PACKAGE_SIZE;
    LOG("ramcode size:%d,%d\r\n",ramcodeSize,pksize);

    mcupk[MCU_RAMCODE_PK_CMD]=0;
    mcupk[MCU_RAMCODE_PK_ADDR_1]=0;
    mcupk[MCU_RAMCODE_PK_ADDR_2]=0;
    mcupk[MCU_RAMCODE_PK_ADDR_3]=0;
    mcupk[MCU_RAMCODE_PK_ADDR_4]=0x20;
    mcupk[MCU_RAMCODE_PK_LEN_1]=ramcodeSize;
    mcupk[MCU_RAMCODE_PK_LEN_2]=ramcodeSize>>8;
    mcupk[MCU_RAMCODE_PK_LEN_3]=0;
    mcupk[MCU_RAMCODE_PK_LEN_4]=0;
    mcupk[MCU_RAMCODE_PK_SUM_1]=get_mcu_sum_check(mcupk,9);
    app_uart_transmit_sync(APP_UART_ID_1,mcupk,10,100);
    mcupk[0]=0;
    app_uart_receive_sync(APP_UART_ID_1,mcupk,1,100);
    if(mcupk[0]!=MCU_ACK_SUCEESS)
    {
        LOG("mcu Ack:%x\r\n",mcupk[0]);
        return WRITE_MCU_RAMCODE_FAIL;     
    }

    for(i=0;i<(ramcodeSize/SEND_PACKAGE_SIZE);i++)
    {
        startAddr=i*SEND_PACKAGE_SIZE;
        memcpy(mcupk,&RamCode[startAddr],SEND_PACKAGE_SIZE);
        mcusum+=get_mcu_sum_check(mcupk,SEND_PACKAGE_SIZE);
        app_uart_transmit_sync(APP_UART_ID_1,mcupk,SEND_PACKAGE_SIZE,100);
    }


    if(pksize)
    {
        startAddr=i*SEND_PACKAGE_SIZE;
        memcpy(mcupk,&RamCode[startAddr],pksize);
        mcupk[pksize]=mcusum+get_mcu_sum_check(mcupk,pksize);
        LOG("ramcode sum:%d\r\n",mcupk[pksize]);
        app_uart_transmit_sync(APP_UART_ID_1,mcupk,pksize+1,100);
        mcupk[0]=0;
        app_uart_receive_sync(APP_UART_ID_1,mcupk,1,1000);
        if(mcupk[0]!=MCU_ACK_SUCEESS)
        {
            LOG("mcu Ack:%x\r\n",mcupk[0]);
            return WRITE_MCU_RAMCODE_FAIL;     
        }
    }
    return MCU_STATUS_OK;
}



/**
 *****************************************************************************************
 * @brief 
 *
 * @param[in]
 *
 * @return 
 *****************************************************************************************
 */
uint16_t mcu_ramcode_run(void)
{
    uint8_t mcupk[11]={0};

    mcupk[0]=0xC0;
    mcupk[9]=0xC0;

    app_uart_transmit_sync(APP_UART_ID_1,mcupk,10,100);
    if(app_uart_receive_sync(APP_UART_ID_1,mcupk,11,100)!=APP_DRV_SUCCESS)
    {
        return MCU_RAMCODE_RUN_FAIL;
    }

    MCU_DELAY_MS(5);

    return MCU_STATUS_OK;
}




/**
 *****************************************************************************************
 * @brief 
 *
 * @param[in]
 *
 * @return 
 *****************************************************************************************
 */
uint16_t mcu_uart_baudrate_set(uint32_t wBaudrate)
{
    uint8_t mcupk[13]={0x49,0x01,0,0,0,0,0x04,0,0,0,0,0,0};

    mcupk[8] =wBaudrate;
    mcupk[9] =wBaudrate>>8;
    mcupk[10]=wBaudrate>>16;
    mcupk[11]=wBaudrate>>24;
    mcupk[12]=get_mcu_sum_check(mcupk,12);

    app_uart_transmit_sync(APP_UART_ID_1,mcupk,13,100);
    mcupk[0]=0;
    app_uart_receive_sync(APP_UART_ID_1,mcupk,9,100);
    if(mcupk[0]!=0x49 || mcupk[8]!=0x49)
    {
        LOG("mcu Ack:%x\r\n",mcupk[0]);
        return MCU_BAUDRATE_SET_FAIL;   
    }
    ll_uart_set_baud_rate(UART1,CLK_64M,wBaudrate);
    // MCU_DELAY_MS(1);
    return MCU_STATUS_OK;
}


/**
 *****************************************************************************************
 * @brief 
 *
 * @param[in]
 *
 * @return 
 *****************************************************************************************
 */
uint16_t mcu_flash_tm_erase(uint32_t tmAddr)//片擦除
{
    uint8_t checksum;
    uint8_t mcupk[9]={0x49,0x02,0,0,0,0,0,0,0};

    mcupk[2]=tmAddr;
    mcupk[3]=tmAddr>>8;
    mcupk[4]=tmAddr>>16;
    mcupk[5]=tmAddr>>24;

    mcupk[8]=get_mcu_sum_check(mcupk,8);

    app_uart_transmit_sync(APP_UART_ID_1,mcupk,9,100);
    mcupk[0]=0;
    app_uart_receive_sync(APP_UART_ID_1,mcupk,9,100);
    checksum=get_mcu_sum_check(mcupk,8);
    if(mcupk[0]!=0x49 || mcupk[8]!=checksum)
    {
        LOG("mcu Ack:%x\r\n",mcupk[0]);
        return MCU_TM_ERASE_FLASH_FAIL;
    }
    MCU_DELAY_MS(50);
    return MCU_STATUS_OK;
}



/**
 *****************************************************************************************
 * @brief 
 *
 * @param[in]
 *
 * @return 
 *****************************************************************************************
 */
uint16_t mcu_flash_tp_erase(uint32_t tpAddr)//页擦除
{
    uint8_t checksum;
    uint8_t mcupk[9]={0x49,0x03,0,0,0,0,0,0,0};

    mcupk[2]=tpAddr;
    mcupk[3]=tpAddr>>8;
    mcupk[4]=tpAddr>>16;
    mcupk[5]=tpAddr>>24;

    mcupk[8]=get_mcu_sum_check(mcupk,8);

    app_uart_transmit_sync(APP_UART_ID_1,mcupk,9,100);
    mcupk[0]=0;
    app_uart_receive_sync(APP_UART_ID_1,mcupk,9,100);
    checksum=get_mcu_sum_check(mcupk,8);
    if(mcupk[0]!=0x49 || mcupk[8]!=checksum)
    {
        LOG("mcu Ack:%x\r\n",mcupk[0]);
        return MCU_TP_ERASE_FLASH_FAIL;     
    }
    return MCU_STATUS_OK;
}

/**
 *****************************************************************************************
 * @brief 
 *
 * @param[in]
 *
 * @return 
 *****************************************************************************************
 */
uint16_t mcu_flash_erase(uint32_t size)
{
    uint16_t sector_count = (size / MCU_FLASH_SECTOR_SIZE) + !!(size % MCU_FLASH_SECTOR_SIZE);

    for (uint16_t i = 0; i < sector_count; i++)
    {
        if (MCU_STATUS_OK != mcu_flash_tp_erase(i * MCU_FLASH_SECTOR_SIZE))
        {
            return MCU_ERASE_FLASH_FAIL;
        }
    }

    return MCU_STATUS_OK;
}

/**
 *****************************************************************************************
 * @brief 
 *
 * @param[in]
 *
 * @return 
 *****************************************************************************************
 */
uint16_t mcu_flash_check_blank(uint32_t wAddr,uint32_t wSize)//空白检查
{
    uint8_t checksum;
    uint8_t mcupk[13]={0x49,0x07,0,0,0,0,0x04,0,0,0,0,0,0};

    mcupk[2] =wAddr;
    mcupk[3] =wAddr>>8;
    mcupk[4] =wAddr>>16;
    mcupk[5] =wAddr>>24;
    mcupk[8] =wSize;
    mcupk[9] =wSize>>8;
    mcupk[10]=wSize>>16;
    mcupk[11]=wSize>>24;

    mcupk[12]=get_mcu_sum_check(mcupk,12);
    app_uart_transmit_sync(APP_UART_ID_1,mcupk,13,100);
    mcupk[0]=0;
    app_uart_receive_sync(APP_UART_ID_1,mcupk,10,100);
    checksum=get_mcu_sum_check(mcupk,9);
    if(mcupk[0]!=0x49 || mcupk[9]!=checksum || mcupk[8]!=MCU_ACK_SUCEESS)
    {
        LOG("mcu Ack:%x\r\n",mcupk[0]);
        return MCU_FLASH_CHECK_BLANK_FAIL;
    }
    return MCU_STATUS_OK;
}



/**
 *****************************************************************************************
 * @brief 
 *
 * @param[in]
 *
 * @return 
 *****************************************************************************************
 */
uint16_t mcu_flash_programming(uint32_t firmwareStartAddr)//编程
{
    uint8_t checksum;
    uint8_t mcupk[SEND_PACKAGE_SIZE+9];
    uint16_t i;
    uint16_t offsetAddr;
    uint16_t ackAddr;


    firmwareCheckSum=0;
    for(i=0;i<(FIRMWARE_SIZE/SEND_PACKAGE_SIZE);i++)
    {
        mcupk[0]=0x49;
        mcupk[1]=4;

        offsetAddr=i*SEND_PACKAGE_SIZE;
        hal_flash_read(firmwareStartAddr+offsetAddr,&mcupk[8], SEND_PACKAGE_SIZE);

        firmwareCheckSum+=get_mcu_sum_check(&mcupk[8],SEND_PACKAGE_SIZE);

        mcupk[2] =offsetAddr;
        mcupk[3] =offsetAddr>>8;
        mcupk[4] =offsetAddr>>16;
        mcupk[5] =offsetAddr>>24;

        mcupk[6] =(uint8_t)SEND_PACKAGE_SIZE;
        mcupk[7] =SEND_PACKAGE_SIZE>>8; 

        mcupk[SEND_PACKAGE_SIZE+8]=get_mcu_sum_check(mcupk,SEND_PACKAGE_SIZE+8);
        app_uart_transmit_sync(APP_UART_ID_1,mcupk,SEND_PACKAGE_SIZE+9,100);
        mcupk[0]=0;
        app_uart_receive_sync(APP_UART_ID_1,mcupk,9,100);
        ackAddr=((mcupk[3]&0xFFFFFFFF)<<8)|mcupk[2];
        checksum=get_mcu_sum_check(mcupk,8);
        if(mcupk[0]!=0x49 || mcupk[8]!=checksum ||offsetAddr!=ackAddr)
        {
            LOG("mcu Ack:%x\r\n",mcupk[0]);
            return MCU_WRITE_FIRMWARE_FAIL;
        }
    }

    if(FIRMWARE_SIZE%SEND_PACKAGE_SIZE)  //非标准
    {
        memset(mcupk,0,sizeof(mcupk));

        mcupk[0]=0x49;
        mcupk[1]=4;

        offsetAddr=i*SEND_PACKAGE_SIZE;
        hal_flash_read(firmwareStartAddr+offsetAddr,&mcupk[8], FIRMWARE_SIZE%SEND_PACKAGE_SIZE);

        firmwareCheckSum+=get_mcu_sum_check(&mcupk[8],SEND_PACKAGE_SIZE);

        mcupk[2] =offsetAddr;
        mcupk[3] =offsetAddr>>8;
        mcupk[4] =offsetAddr>>16;
        mcupk[5] =offsetAddr>>24;

        mcupk[6] =(uint8_t)SEND_PACKAGE_SIZE;
        mcupk[7] =SEND_PACKAGE_SIZE>>8;

        mcupk[SEND_PACKAGE_SIZE+8]=get_mcu_sum_check(mcupk,SEND_PACKAGE_SIZE+8);
        app_uart_transmit_sync(APP_UART_ID_1,mcupk,SEND_PACKAGE_SIZE+9,100);
        mcupk[0]=0;
        app_uart_receive_sync(APP_UART_ID_1,mcupk,9,100);
        ackAddr=((mcupk[3]&0xFFFFFFFF)<<8)|mcupk[2];
        checksum=get_mcu_sum_check(mcupk,8);
        if(mcupk[0]!=0x49 || mcupk[8]!=checksum ||offsetAddr!=ackAddr)
        {
            LOG("mcu Ack:%x\r\n",mcupk[0]);
            return MCU_WRITE_FIRMWARE_FAIL;
        }
    }
    return MCU_STATUS_OK;
}


/**
 *****************************************************************************************
 * @brief 
 *
 * @param[in]
 *
 * @return 
 *****************************************************************************************
 */
uint16_t mcu_get_firmware_checksum(uint32_t checksize)
{
    uint8_t checksum;
    uint8_t mcupk[13]={0x49,6,0,0,0,0,4,0,0,0,0,0,0};
    uint16_t fmchecksum;

    mcupk[8] =checksize;
    mcupk[9] =checksize>>8;
    mcupk[10]=checksize>>16;
    mcupk[11]=checksize>>24;
    mcupk[12]=get_mcu_sum_check(mcupk,12);

    app_uart_transmit_sync(APP_UART_ID_1,mcupk,13,100);
    mcupk[0]=0;
    app_uart_receive_sync(APP_UART_ID_1,mcupk,11,100);
    checksum=get_mcu_sum_check(mcupk,10);
    if(mcupk[0]!=0x49 || mcupk[10]!=checksum)
    {
        LOG("mcu Ack:%x\r\n",mcupk[0]);
        return MCU_GET_FIRMWARE_ECC_FAIL;
    }
    fmchecksum=((mcupk[9]&0XFFFF)<<8)|mcupk[8];

    if(fmchecksum!=firmwareCheckSum)
    {
        LOG("fm check sum:%4x,%4x\r\n",fmchecksum,firmwareCheckSum);
        return MCU_FIRMWARE_ECC_VERIFY_FAIL;
    }
    return MCU_STATUS_OK;
}




/**
 *****************************************************************************************
 * @brief 
 *
 * @param[in]
 *
 * @return 
 *****************************************************************************************
 */
uint16_t mcu_flash_encryption(void)//加密
{
    uint8_t mcupk[9]={0x49,9,0,0,0,0,0,0,0};


    mcupk[8]=get_mcu_sum_check(mcupk,8);

    app_uart_transmit_sync(APP_UART_ID_1,mcupk,9,100);
    mcupk[0]=0;
    app_uart_receive_sync(APP_UART_ID_1,mcupk,9,100);
    if(mcupk[0]!=0x49 || mcupk[8]!=0x49)
    {
        LOG("mcu Ack:%x\r\n",mcupk[0]);
        return MCU_FIRMWARE_ENCRYPTION_FAIL;
    }
    return MCU_STATUS_OK;
}




/**
 *****************************************************************************************
 * @brief 
 *
 * @param[in]
 *
 * @return 
 *****************************************************************************************
 */
uint16_t mcu_upgraded_reset(void)//复位
{
    uint8_t mcupk[9]={0x49,0x0A,0,0,0,0,0,0,0};

    mcupk[8]=get_mcu_sum_check(mcupk,8);
    app_uart_transmit_sync(APP_UART_ID_1,mcupk,9,100);
    mcupk[0]=0;
    app_uart_receive_sync(APP_UART_ID_1,mcupk,9,100);
    if(mcupk[0]!=0x49 || mcupk[8]!=0x49)
    {
        LOG("mcu Ack:%x\r\n",mcupk[0]);
        return MCU_UPGRADE_RESET_FAIL;
    }
    return MCU_STATUS_OK;
}



/**
 *****************************************************************************************
 * @brief 
 *
 * @param[in]
 *
 * @return 
 *****************************************************************************************
 */
uint16_t mcu_upgrade_handle(uint32_t firmwareStartAddr)
{
    ll_uart_set_baud_rate(UART1,CLK_64M,MCU_RAMBOOT_BAUDRATE);

    if(mcu_enter_romboot()!=MCU_STATUS_OK)
    {
        return ENTER_MCU_RAMCODE_MODE_FAIL;
    }

    maxeye_wdt_refresh();

    if(write_mcu_ramcode()!=MCU_STATUS_OK)
    {
        return WRITE_MCU_RAMCODE_FAIL;
    }

    if(mcu_ramcode_run()!=MCU_STATUS_OK)
    {
        return MCU_RAMCODE_RUN_FAIL;
    }

    if(mcu_uart_baudrate_set(MCU_UPGRADE_BAUDRATE)!=MCU_STATUS_OK)          // 49 01
    {
        return MCU_BAUDRATE_SET_FAIL;
    }

    if(mcu_flash_erase(FIRMWARE_SIZE)!=MCU_STATUS_OK)                       // 49 03
    {
        return MCU_ERASE_FLASH_FAIL;
    }

    if(mcu_flash_check_blank(0,FIRMWARE_SIZE)!=MCU_STATUS_OK)               // 49 07
    {
        return MCU_FLASH_CHECK_BLANK_FAIL;
    }

    maxeye_wdt_refresh();

    if(mcu_flash_programming(firmwareStartAddr)!=MCU_STATUS_OK)             // 49 04
    {
        return MCU_WRITE_FIRMWARE_FAIL;
    }

    if(mcu_get_firmware_checksum(FIRMWARE_SIZE)!=MCU_STATUS_OK)             // 49 06
    {
        return MCU_FIRMWARE_ECC_VERIFY_FAIL;
    }

    // if(mcu_flash_encryption()!=MCU_STATUS_OK)                            // 49 09
    // {
    //  return MCU_FIRMWARE_ENCRYPTION_FAIL;
    // }

    if(mcu_upgraded_reset()!=MCU_STATUS_OK)                                 // 49 0A
    {
        return MCU_UPGRADE_RESET_FAIL;
    }

    mcu_reset_control();

    return MCU_STATUS_OK;
}



