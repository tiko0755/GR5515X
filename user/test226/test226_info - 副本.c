/**
 *****************************************************************************************
 *
 * @file test226_read_sn.c
 *
 * @brief 
 *
 *****************************************************************************************
 */

/*
 * INCLUDE FILES
 *****************************************************************************************
 */
#include "test226.h"
#include "test226_info.h"
#include "info_SrvClientCB.h"

/*
 * DEFINES
 *****************************************************************************************
 */

/*
 * LOCAL VARIABLE DEFINITIONS
 *****************************************************************************************
 */
 
/*
 * GLOBAL VARIABLE DEFINITIONS
 *****************************************************************************************
 */
 
 
/*
 * LOCAL FUNCTION DEFINITIONS
 *****************************************************************************************
 */
// device info read SN
#define INFO_SN_UUID_LEN	(2)
const uint8_t INFO_SN_UUID[INFO_SN_UUID_LEN]=	{0x25, 0x2a};

#define SN_MAX_LEN	(20)
static char foundSerial[SN_MAX_LEN] = {0};
static uint8_t squReadSN = 0;
static uint8_t tickReadSN = 0;

/**
 *****************************************************************************************
 * @brief 
 *
 * @param[in]
 *
 * @return 
 *****************************************************************************************
 */
static void evntInfoAttrReadCmplt_SN(uint8_t conn_idx, uint8_t status, const ble_gattc_read_rsp_t *p_read_rsp){
	if(squReadSN == PRC_WAIT){
		memset(foundSerial,0,SN_MAX_LEN);
		memcpy(foundSerial, p_read_rsp->vals[0].p_value, p_read_rsp->vals[0].length);
		squReadSN = PRC_SUCCESS;
	}
}

int32_t readSN(char* sn){
	if(squReadSN == PRC_SUCCESS){
		strcpy(sn, foundSerial);
		return 0;
	}
	return -1;
}

void startReadSN(){
	squReadSN = 1;
}
void stopReadSN(){
	squReadSN = 0;
}

void taskReadSN(uint16_t tick){
	switch(squReadSN){
		case PRC_START:
			if(pInfoSrvClient && pInfoSrvClient->rsrc.isBuilded){
				memset(foundSerial,0,20);
				pInfoSrvClient->ReadAttr(&pInfoSrvClient->rsrc, INFO_SN_UUID, INFO_SN_UUID_LEN, evntInfoAttrReadCmplt_SN);
				squReadSN++;
			}
			break;
		case PRC_WAIT:
			tickReadSN += tick;
			break;
		case PRC_SUCCESS:
			break;
	}
}

/**
 *****************************************************************************************
 * @brief 
 *
 * @param[in]
 *
 * @return 
 *****************************************************************************************
 */




/**
 *****************************************************************************************
 * @brief 
 *
 * @param[in]
 *
 * @return 
 *****************************************************************************************
 */



/**
 *****************************************************************************************
 * @brief 
 *
 * @param[in]
 *
 * @return 
 *****************************************************************************************
 */





/**
 *****************************************************************************************
 * @brief 
 *
 * @param[in]
 *
 * @return 
 *****************************************************************************************
 */



/**
 *****************************************************************************************
 * @brief 
 *
 * @param[in]
 *
 * @return 
 *****************************************************************************************
 */




/**
 *****************************************************************************************
 * @brief 
 *
 * @param[in]
 *
 * @return 
 *****************************************************************************************
 */





/**
 *****************************************************************************************
 * @brief 
 *
 * @param[in]
 *
 * @return 
 *****************************************************************************************
 */



/**
 *****************************************************************************************
 * @brief 
 *
 * @param[in]
 *
 * @return 
 *****************************************************************************************
 */


/**
 *****************************************************************************************
 * @brief 
 *
 * @param[in]
 *
 * @return 
 *****************************************************************************************
 */


